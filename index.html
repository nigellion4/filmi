<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a0f0a">
    <title>Filmi - Movie Night Voting</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpbG1pIiwKICAic2hvcnRfbmFtZSI6ICJGaWxtaSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWEwZjBhIiwKICAidGhlbWVfY29sb3IiOiAiIzFhMGYwYSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyclM0UlM0NyZWN0IHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyBmaWxsPSclMjMxYTBmMGEnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzEwMCcgZm9udC1mYW1pbHk9J3NlcmlmJyBmaWxsPSclMjNmZmIzNTcnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdjZW50cmFsJyUzRUYlM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a0f0a;
            --bg-secondary: #2a1f1a;
            --bg-card: #3a2f2a;
            --text-primary: #f5e6d3;
            --text-secondary: #d4b896;
            --accent-gold: #ffb357;
            --accent-red: #c41e3a;
            --accent-teal: #5dade2;
            --shadow: rgba(0, 0, 0, 0.5);
            --glow: rgba(255, 179, 87, 0.3);
        }

        body {
            font-family: 'Lato', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.03) 2px,
                    rgba(0, 0, 0, 0.03) 4px
                );
            pointer-events: none;
            z-index: 9999;
            opacity: 0.3;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(26, 15, 10, 0.4) 100%);
            pointer-events: none;
            z-index: 1;
        }

        #root {
            position: relative;
            z-index: 2;
        }

        .app-container {
            min-height: 100vh;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 40px 20px 30px;
            position: relative;
            margin-bottom: 40px;
        }

        .marquee-lights {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 8px;
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-gold);
            box-shadow: 0 0 10px var(--accent-gold), 0 0 20px var(--glow);
            animation: bulb-glow 2s ease-in-out infinite;
        }

        .light:nth-child(2) { animation-delay: 0.2s; }
        .light:nth-child(3) { animation-delay: 0.4s; }
        .light:nth-child(4) { animation-delay: 0.6s; }
        .light:nth-child(5) { animation-delay: 0.8s; }

        @keyframes bulb-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .app-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 5rem;
            letter-spacing: 0.15em;
            color: var(--accent-gold);
            text-shadow: 
                0 0 20px var(--glow),
                0 0 40px var(--glow),
                3px 3px 0 var(--accent-red),
                6px 6px 10px var(--shadow);
            margin: 20px 0 10px;
            animation: title-flicker 3s ease-in-out infinite;
        }

        @keyframes title-flicker {
            0%, 100% { opacity: 1; }
            94% { opacity: 1; }
            95% { opacity: 0.8; }
            96% { opacity: 1; }
            97% { opacity: 0.9; }
            98% { opacity: 1; }
        }

        .app-subtitle {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-style: italic;
            letter-spacing: 0.05em;
        }

        .mode-badge {
            display: inline-block;
            padding: 6px 14px;
            background: var(--accent-teal);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 10px;
            letter-spacing: 0.05em;
        }

        .mode-badge.local {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .lobby-section {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            margin: 0 auto;
            border: 2px solid rgba(255, 179, 87, 0.2);
            box-shadow: 0 8px 32px var(--shadow);
            text-align: center;
        }

        .lobby-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 30px;
            letter-spacing: 0.1em;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .mode-card.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px var(--glow);
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .mode-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
            letter-spacing: 0.1em;
        }

        .mode-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        input[type="text"], select {
            width: 100%;
            padding: 15px 20px;
            background: var(--bg-primary);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Lato', sans-serif;
            font-size: 1.1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            box-shadow: 0 0 20px var(--glow);
            border-color: var(--accent-gold);
        }

        button {
            width: 100%;
            padding: 15px 28px;
            background: linear-gradient(135deg, var(--accent-red) 0%, #8b0000 100%);
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(196, 30, 58, 0.4);
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(196, 30, 58, 0.6);
            background: linear-gradient(135deg, #d4243d 0%, #a00000 100%);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #d49200 100%);
            box-shadow: 0 4px 15px rgba(255, 179, 87, 0.4);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #ffc46b 0%, #e5a300 100%);
            box-shadow: 0 6px 25px rgba(255, 179, 87, 0.6);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 179, 87, 0.2);
        }

        .divider span {
            padding: 0 20px;
        }

        .room-info {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 20px var(--glow);
        }

        .room-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--accent-gold);
            letter-spacing: 0.2em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        .room-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .user-section {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 179, 87, 0.2);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .user-input-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-input-group input {
            flex: 1;
            min-width: 200px;
            text-align: left;
        }

        .user-input-group button {
            width: auto;
            padding: 12px 28px;
        }

        .users-list {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .users-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            letter-spacing: 0.1em;
        }

        .user-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .user-tag {
            padding: 8px 16px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(255, 179, 87, 0.3);
            animation: user-join 0.3s ease-out;
        }

        @keyframes user-join {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .user-tag.current-user {
            background: var(--accent-red);
            color: white;
        }

        .remove-user {
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .remove-user:hover {
            opacity: 1;
        }

        .session-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .session-controls button {
            flex: 1;
        }

        .phase-indicator {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            border: 2px solid var(--accent-gold);
        }

        .phase-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
            letter-spacing: 0.1em;
        }

        .phase-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .phase-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .stat-item {
            padding: 10px 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .stat-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
        }

        .finalists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .finalist-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 8px 32px var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .finalist-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(255, 179, 87, 0.6);
        }

        .finalist-card.selected {
            border-color: var(--accent-red);
            box-shadow: 0 0 40px rgba(196, 30, 58, 0.8);
        }

        .finalist-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(255, 179, 87, 0.5);
        }

        .vote-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            background: var(--accent-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(196, 30, 58, 0.5);
        }

        .favorite-count {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.85rem;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(255, 179, 87, 0.4);
        }

        .favorite-btn {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 3px solid var(--accent-gold);
            background: transparent;
            color: var(--accent-gold);
            font-size: 1.1rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .favorite-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 179, 87, 0.6);
        }

        .favorite-btn.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px var(--glow);
        }

        .ranked-voting-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .rank-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 3px solid;
            background: transparent;
            font-size: 0.95rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .rank-btn.first {
            border-color: #FFD700;
            color: #FFD700;
        }

        .rank-btn.first:hover, .rank-btn.first.active {
            background: #FFD700;
            color: var(--bg-primary);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .rank-btn.second {
            border-color: #C0C0C0;
            color: #C0C0C0;
        }

        .rank-btn.second:hover, .rank-btn.second.active {
            background: #C0C0C0;
            color: var(--bg-primary);
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.6);
        }

        .rank-btn.third {
            border-color: #CD7F32;
            color: #CD7F32;
        }

        .rank-btn.third:hover, .rank-btn.third.active {
            background: #CD7F32;
            color: var(--bg-primary);
            box-shadow: 0 0 20px rgba(205, 127, 50, 0.6);
        }

        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-primary);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--accent-gold);
            margin-bottom: 20px;
        }

        .toggle-switch:hover {
            box-shadow: 0 0 15px var(--glow);
        }

        .toggle-switch input[type="checkbox"] {
            width: 50px;
            height: 26px;
            appearance: none;
            background: var(--bg-card);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--accent-gold);
        }

        .toggle-switch input[type="checkbox"]:checked {
            background: var(--accent-gold);
        }

        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch input[type="checkbox"]:checked::before {
            left: 26px;
        }

        .search-section {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 179, 87, 0.15);
        }

        .search-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            letter-spacing: 0.1em;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-filters input,
        .search-filters select {
            text-align: left;
        }

        .search-filters button {
            width: auto;
            padding: 12px 20px;
        }

        .search-input-container {
            position: relative;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--accent-gold);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 179, 87, 0.1);
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .suggestion-poster {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .suggestion-poster-placeholder {
            width: 40px;
            height: 60px;
            background: var(--bg-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .suggestion-info {
            flex: 1;
            min-width: 0;
        }

        .suggestion-title {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .suggestion-year {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .movie-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
        }

        .movie-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--glow) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .movie-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent-gold);
            box-shadow: 0 12px 40px rgba(255, 179, 87, 0.4);
        }

        .movie-card:hover::before {
            opacity: 1;
        }

        .movie-poster {
            width: 100%;
            height: 400px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        }

        .movie-info {
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .movie-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent-gold);
        }

        .movie-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .movie-overview {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .streaming-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .streaming-badge {
            padding: 4px 10px;
            background: var(--accent-teal);
            color: white;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .streaming-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            filter: brightness(1.2);
        }

        .streaming-badge.clickable {
            cursor: pointer;
        }

        .streaming-link {
            text-decoration: none;
            color: inherit;
        }

        .voting-section {
            display: flex;
            gap: 10px;
            justify-content: space-around;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 179, 87, 0.2);
        }

        .vote-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid;
            background: transparent;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            width: auto;
            margin: 0;
        }

        .vote-btn.like {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .vote-btn.like:hover, .vote-btn.like.active {
            background: #2ecc71;
            color: white;
        }

        .vote-btn.maybe {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .vote-btn.maybe:hover, .vote-btn.maybe.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .vote-btn.no {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .vote-btn.no:hover, .vote-btn.no.active {
            background: #e74c3c;
            color: white;
        }

        .vote-count {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .vote-users {
            font-size: 0.7rem;
            opacity: 0.7;
            max-height: 40px;
            overflow-y: auto;
        }

        .results-section {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 30px;
            border-radius: 15px;
            margin-top: 40px;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .results-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--accent-gold);
            text-align: center;
            margin-bottom: 30px;
            letter-spacing: 0.15em;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        .winner-card {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 0 40px var(--glow), 0 8px 32px var(--shadow);
            animation: winner-glow 2s ease-in-out infinite;
            transition: transform 0.3s ease;
        }

        .winner-card:hover {
            transform: scale(1.02);
            box-shadow: 0 0 60px var(--glow), 0 12px 48px var(--shadow);
        }

        @keyframes winner-glow {
            0%, 100% { box-shadow: 0 0 40px var(--glow), 0 8px 32px var(--shadow); }
            50% { box-shadow: 0 0 60px var(--glow), 0 12px 48px var(--shadow); }
        }

        .winner-poster {
            max-width: 300px;
            margin: 0 auto 20px;
            border-radius: 10px;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .winner-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .winner-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--accent-red);
            margin: 20px 0;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        .ranked-list {
            margin-top: 30px;
        }

        .ranked-item {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-left: 4px solid var(--accent-gold);
            transition: all 0.3s ease;
        }

        .ranked-item:hover {
            transform: translateX(10px);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .rank-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--accent-gold);
            min-width: 40px;
        }

        .ranked-poster {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
        }

        .ranked-info {
            flex: 1;
        }

        .ranked-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .ranked-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .copy-button {
            display: inline-block;
            padding: 8px 16px;
            background: var(--accent-teal);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: all 0.3s ease;
            border: none;
            width: auto;
        }

        .copy-button:hover {
            background: #4a9fd5;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 3rem;
            }

            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .search-filters {
                grid-template-columns: 1fr;
            }

            .lobby-section {
                padding: 25px;
            }

            .room-code {
                font-size: 2rem;
            }

            .mode-selector {
                grid-template-columns: 1fr;
            }

            .user-input-group {
                flex-direction: column;
            }

            .user-input-group input,
            .user-input-group button {
                width: 100%;
            }
        }

        /* Movie Details Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border: 2px solid var(--accent-gold);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--accent-red);
        }

        .modal-header {
            position: relative;
            height: 400px;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
        }

        .modal-backdrop {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.4);
        }

        .modal-poster {
            position: absolute;
            bottom: -50px;
            left: 30px;
            width: 200px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            border: 4px solid var(--bg-card);
            z-index: 5;
        }

        .modal-body {
            padding: 70px 30px 30px 260px;
            min-height: 150px;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .modal-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .modal-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .modal-section {
            margin-top: 30px;
        }

        .modal-section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            letter-spacing: 0.1em;
        }

        .modal-overview {
            line-height: 1.8;
            color: var(--text-primary);
            font-size: 1.05rem;
        }

        .trailer-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            background: var(--bg-primary);
        }

        .trailer-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .cast-member {
            text-align: center;
        }

        .cast-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-gold);
            margin-bottom: 8px;
        }

        .cast-name {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .cast-character {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .no-trailer {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .modal-content {
                max-height: 95vh;
            }

            .modal-header {
                height: 250px;
            }

            .modal-poster {
                width: 120px;
                left: 20px;
                bottom: -40px;
            }

            .modal-body {
                padding: 50px 20px 20px 160px;
            }

            .modal-title {
                font-size: 1.8rem;
            }

            .cast-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .cast-photo {
                width: 80px;
                height: 80px;
            }
        }
        /* Profile System Styles */
        .profile-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.85) 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1001;
            border-bottom: 2px solid var(--accent-gold);
            min-height: 70px;
            transition: all 0.3s ease;
        }

        .profile-bar.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .profile-bar.minimized {
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .profile-toggle-btn {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1002;
            background: var(--accent-gold);
            color: #000;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .profile-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.4);
        }

        .profile-toggle-btn.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Sharing Buttons */
        .sharing-section {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-btn {
            padding: 10px 20px;
            background: var(--accent-gold);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.4);
        }

        .share-btn.secondary {
            background: rgba(218, 165, 32, 0.2);
            color: var(--accent-gold);
            border: 1px solid var(--accent-gold);
        }

        .share-btn.secondary:hover {
            background: rgba(218, 165, 32, 0.3);
        }

        /* QR Code Modal */
        .qr-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .qr-modal {
            background: var(--bg-primary);
            border: 3px solid var(--accent-gold);
            border-radius: 15px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 40px var(--glow);
            position: relative;
        }

        .qr-modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            letter-spacing: 0.1em;
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: inline-block;
        }

        .qr-code-container img {
            display: block;
            width: 250px;
            height: 250px;
        }

        .qr-instructions {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 15px;
            line-height: 1.5;
        }

        .qr-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .qr-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .profile-bar.compact {
            padding: 8px 20px;
            min-height: 50px;
        }

        .profile-bar.compact .profile-avatar,
        .profile-bar.compact .profile-avatar-placeholder {
            width: 32px;
            height: 32px;
            font-size: 1rem;
        }

        .profile-bar.compact .profile-name {
            font-size: 0.9rem;
        }

        .profile-bar.compact .profile-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .profile-bar.compact .profile-login input {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-width: 160px;
        }

        .profile-login {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-login input {
            padding: 10px 18px;
            border: 1px solid var(--accent-gold);
            background: rgba(0,0,0,0.7);
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 0.95rem;
            min-width: 200px;
        }

        .profile-header {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
            object-fit: cover;
            cursor: pointer;
        }

        .profile-avatar-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
            background: var(--accent-gold);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        .profile-name {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: bold;
        }

        .profile-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .profile-btn:hover {
            background: var(--accent-gold);
            color: #000;
        }

        .watchlist-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .watchlist-btn {
            padding: 6px 12px;
            font-size: 0.75rem;
            border: 1px solid var(--accent-gold);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .watchlist-btn:hover {
            background: rgba(218, 165, 32, 0.2);
        }

        .watchlist-btn.active {
            background: var(--accent-gold);
            color: #000;
            font-weight: bold;
        }

        .watchlist-btn.remove {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .watchlist-btn.remove:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .profile-screen {
            padding: 80px 40px 40px;
            min-height: 100vh;
        }

        .profile-screen-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-photo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
            gap: 15px;
        }

        .profile-photo-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--accent-gold);
            object-fit: cover;
        }

        .profile-photo-placeholder-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--accent-gold);
            background: var(--accent-gold);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: bold;
        }

        .photo-upload-btn {
            display: none;
        }

        .watchlist-tabs {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .watchlist-tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            cursor: pointer;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
            transition: all 0.3s;
        }

        .watchlist-tab:hover {
            background: rgba(218, 165, 32, 0.2);
            transform: translateY(-2px);
        }

        .watchlist-tab.active {
            background: var(--accent-gold);
            color: #000;
        }

        .watchlist-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 2;
        }

        .watchlist-badge.seen {
            background: #4caf50;
            color: #fff;
        }

        .watchlist-badge.want {
            background: var(--accent-gold);
            color: #000;
        }

        /* Login Modal Styles */
        .login-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-modal {
            background: var(--bg-primary);
            border: 3px solid var(--accent-gold);
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 0 40px var(--glow);
            position: relative;
        }

        .login-modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
            letter-spacing: 0.1em;
        }

        .login-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-label {
            display: block;
            color: var(--accent-gold);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .login-form-label.optional {
            color: var(--text-secondary);
        }

        .login-form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.3);
        }

        .login-form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .login-form-submit {
            flex: 1;
            padding: 14px;
            background: var(--accent-gold);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-form-submit:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.4);
        }

        .login-form-cancel {
            flex: 1;
            padding: 14px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--text-secondary);
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-form-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .login-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .login-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .profile-bar {
                padding: 12px 15px;
                min-height: 60px;
                flex-wrap: wrap;
            }

            .profile-login {
                gap: 10px;
            }

            .profile-login input {
                min-width: 150px;
                font-size: 0.9rem;
                padding: 8px 12px;
            }

            .profile-header {
                gap: 12px;
            }

            .profile-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .profile-screen {
                padding: 80px 20px 20px;
            }

            .watchlist-tabs {
                flex-direction: column;
            }

            .watchlist-tab {
                width: 100%;
            }
        }

        /* Sticky Submit Button */
        .sticky-submit-button {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwnzJsGYFtlKXPimO8FXZAYFQjHl65bUI",
            authDomain: "filmi-67e78.firebaseapp.com",
            databaseURL: "https://filmi-67e78-default-rtdb.firebaseio.com",
            projectId: "filmi-67e78",
            storageBucket: "filmi-67e78.firebasestorage.app",
            messagingSenderId: "818521726994",
            appId: "1:818521726994:web:4c110d872dec7f641738cb",
            measurementId: "G-HLL4JBK97N"
        };

        // Initialize Firebase with error handling
        let database = null;
        let firebaseInitialized = false;

        // Only initialize if config is provided
        if (firebaseConfig.apiKey && firebaseConfig.databaseURL) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                firebaseInitialized = true;
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }
        }

        const TMDB_API_KEY = '3fd2be6f0c70a2a598f084ddfb75487c';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

        const RANKED_VOTE_POINTS = {
            first: 3,
            second: 2,
            third: 1
        };

        const VOTING_PHASES = {
            BROWSING: 'browsing',       // Phase 1: Select favorites
            FINAL_VOTE: 'final_vote',   // Phase 2: Ranked voting
            WINNER: 'winner'            // Phase 3: Winner announced
        };

        const GENRES = {
            28: "Action", 12: "Adventure", 16: "Animation", 35: "Comedy", 80: "Crime",
            99: "Documentary", 18: "Drama", 10751: "Family", 14: "Fantasy", 36: "History",
            27: "Horror", 10402: "Music", 9648: "Mystery", 10749: "Romance", 878: "Sci-Fi",
            10770: "TV Movie", 53: "Thriller", 10752: "War", 37: "Western",
            'holiday': "Holiday" // Special keyword search
        };

        const DECADES = [
            { value: '', label: 'All Decades' },
            { value: '2020-2029', label: '2020s' },
            { value: '2010-2019', label: '2010s' },
            { value: '2000-2009', label: '2000s' },
            { value: '1990-1999', label: '1990s' },
            { value: '1980-1989', label: '1980s' },
            { value: '1970-1979', label: '1970s' },
            { value: '1960-1969', label: '1960s' },
            { value: '1950-1959', label: '1950s' }
        ];

        const LANGUAGES = [
            { value: '', label: 'All Languages' },
            { value: 'en', label: 'English' },
            { value: 'hi', label: 'Hindi' },
            { value: 'ta', label: 'Tamil' },
            { value: 'te', label: 'Telugu' },
            { value: 'ml', label: 'Malayalam' },
            { value: 'kn', label: 'Kannada' },
            { value: 'ko', label: 'Korean' },
            { value: 'ja', label: 'Japanese' },
            { value: 'zh', label: 'Chinese' },
            { value: 'es', label: 'Spanish' },
            { value: 'fr', label: 'French' },
            { value: 'de', label: 'German' },
            { value: 'it', label: 'Italian' },
            { value: 'pt', label: 'Portuguese' },
            { value: 'ru', label: 'Russian' },
            { value: 'ar', label: 'Arabic' },
            { value: 'tr', label: 'Turkish' }
        ];

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function App() {
            const [mode, setMode] = useState(''); // 'local' or 'online'
            const [screen, setScreen] = useState('lobby'); // 'lobby', 'session', 'profile'
            const [isScrolled, setIsScrolled] = useState(false);
            const [isProfileBarMinimized, setIsProfileBarMinimized] = useState(false);
            const [showQRModal, setShowQRModal] = useState(false);
            
            // User Profile & Watchlist System
            const [userProfile, setUserProfile] = useState(null); // { username, email, password, watchlist: { movieId: 'seen'/'want' }, photo: base64 }
            const [showProfileMenu, setShowProfileMenu] = useState(false);
            const [watchlistFilter, setWatchlistFilter] = useState(null); // 'seen', 'want', or null
            const [profileLoginInput, setProfileLoginInput] = useState('');
            const [roomCode, setRoomCode] = useState('');
            const [userName, setUserName] = useState('');
            const [joinCode, setJoinCode] = useState('');
            const [error, setError] = useState('');
            
            // Local mode state
            const [localUsers, setLocalUsers] = useState([]);
            const [newUserName, setNewUserName] = useState('');
            const [localFavorites, setLocalFavorites] = useState({}); // {movieId: {userName: true}}
            const [localRankedVotes, setLocalRankedVotes] = useState({}); // {userName: {first: movieId, second: movieId, third: movieId}}
            const [localVotingPhase, setLocalVotingPhase] = useState(VOTING_PHASES.BROWSING);
            const [largeGroupMode, setLargeGroupMode] = useState(false); // Toggle for 1 vs 3 favorites
            const [currentVoterIndex, setCurrentVoterIndex] = useState(0); // Track which user is voting in local mode
            const [localFavoritesSubmitted, setLocalFavoritesSubmitted] = useState([]); // Array of usernames who submitted favorites
            const [localRankedSubmitted, setLocalRankedSubmitted] = useState([]); // Array of usernames who submitted ranked votes
            
            // Online mode state
            const [sessionData, setSessionData] = useState(null);
            
            // Shared state
            const [movies, setMovies] = useState([]);
            const [hasLocalSearchResults, setHasLocalSearchResults] = useState(false); // Track if user did a local search
            const [searchQuery, setSearchQuery] = useState('');
            const [searchSuggestions, setSearchSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [selectedSuggestionIndex, setSelectedSuggestionIndex] = useState(-1);
            const [selectedGenre, setSelectedGenre] = useState('');
            const [selectedDecade, setSelectedDecade] = useState('');
            const [selectedLanguage, setSelectedLanguage] = useState('');
            const [sortBy, setSortBy] = useState('popularity'); // 'popularity', 'new_releases', 'highest_rated'
            
            // Advanced filters
            const [selectedRuntime, setSelectedRuntime] = useState(''); // '', 'short', 'medium', 'long'
            const [selectedRating, setSelectedRating] = useState(''); // '', 'G', 'PG', 'PG-13', 'R'
            const [selectedStreamingServices, setSelectedStreamingServices] = useState([]); // Array of service IDs
            const [minImdbRating, setMinImdbRating] = useState(0); // 0-10
            const [yearRange, setYearRange] = useState({ min: 1970, max: new Date().getFullYear() });
            
            const [loading, setLoading] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const [hasMorePages, setHasMorePages] = useState(true);
            const [selectedMovie, setSelectedMovie] = useState(null);
            const [movieDetails, setMovieDetails] = useState(null);

            // Listen to Firebase in online mode
            useEffect(() => {
                if (mode === 'online' && screen === 'session' && roomCode && firebaseInitialized) {
                    const sessionRef = database.ref(`sessions/${roomCode}`);
                    
                    sessionRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setSessionData(data);
                            // Only update movies if user doesn't have local search results
                            if (data.movies && !hasLocalSearchResults) {
                                const movieList = Object.values(data.movies);
                                setMovies(movieList);
                            }
                        }
                    });

                    return () => sessionRef.off();
                }
            }, [mode, screen, roomCode, hasLocalSearchResults]);

            // Auto-search when filters change
            useEffect(() => {
                if (screen !== 'session') return;
                
                // Only trigger if at least one filter is set (not initial load)
                if (selectedGenre || selectedDecade || selectedLanguage || sortBy !== 'popularity') {
                    if (mode === 'local') {
                        searchMoviesLocal();
                    } else {
                        searchMoviesOnline();
                    }
                }
            }, [selectedGenre, selectedDecade, selectedLanguage, sortBy]);

            // Detect scroll for shrinking profile bar
            useEffect(() => {
                const handleScroll = () => {
                    setIsScrolled(window.scrollY > 20);
                };

                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            // Load saved profile on mount (persist login across reloads)
            useEffect(() => {
                const savedUsername = localStorage.getItem('filmi_current_user');
                if (savedUsername) {
                    const profile = loadUserProfile(savedUsername);
                    if (profile) {
                        setUserProfile(profile);
                    }
                }
            }, []);

            const fetchMovieDetails = async (movieId) => {
                try {
                    // Fetch movie details including videos
                    const response = await fetch(
                        `${TMDB_BASE_URL}/movie/${movieId}?api_key=${TMDB_API_KEY}&append_to_response=videos,credits`
                    );
                    const data = await response.json();
                    
                    // Find YouTube trailer
                    const trailer = data.videos?.results?.find(
                        video => video.type === 'Trailer' && video.site === 'YouTube'
                    ) || data.videos?.results?.find(
                        video => video.site === 'YouTube'
                    );
                    
                    return {
                        ...data,
                        trailer: trailer ? `https://www.youtube.com/embed/${trailer.key}` : null,
                        cast: data.credits?.cast?.slice(0, 6) || []
                    };
                } catch (error) {
                    console.error('Error fetching movie details:', error);
                    return null;
                }
            };

            // Autocomplete search with debounce
            const fetchSearchSuggestions = async (query) => {
                if (!query || query.length < 2) {
                    setSearchSuggestions([]);
                    return;
                }

                try {
                    // Search both movies and people (actors)
                    const [movieResponse, peopleResponse] = await Promise.all([
                        fetch(`${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&page=1`),
                        fetch(`${TMDB_BASE_URL}/search/person?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&page=1`)
                    ]);
                    
                    const movieData = await movieResponse.json();
                    const peopleData = await peopleResponse.json();
                    
                    // Get movie suggestions
                    const movieSuggestions = (movieData.results || []).slice(0, 5).map(movie => ({
                        id: movie.id,
                        title: movie.title,
                        year: movie.release_date?.split('-')[0],
                        poster: movie.poster_path,
                        type: 'movie'
                    }));
                    
                    // Get actor suggestions (only actors, not crew)
                    const actorSuggestions = (peopleData.results || [])
                        .filter(person => person.known_for_department === 'Acting')
                        .slice(0, 3)
                        .map(person => ({
                            id: person.id,
                            title: person.name,
                            year: person.known_for?.[0]?.title || person.known_for?.[0]?.name,
                            poster: person.profile_path,
                            type: 'actor',
                            knownFor: person.known_for?.slice(0, 2).map(m => m.title || m.name).join(', ')
                        }));
                    
                    // Combine and limit to 8 total
                    const combined = [...movieSuggestions, ...actorSuggestions].slice(0, 8);
                    setSearchSuggestions(combined);
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    setSearchSuggestions([]);
                }
            };

            // Debounce timer
            let searchTimeout;
            const handleSearchInput = (value) => {
                setSearchQuery(value);
                setShowSuggestions(true);
                setSelectedSuggestionIndex(-1);
                
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    fetchSearchSuggestions(value);
                }, 300); // Wait 300ms after user stops typing
            };

            const selectSuggestion = async (suggestion) => {
                setShowSuggestions(false);
                setSearchSuggestions([]);
                
                // When selecting a suggestion, clear filters (search overrides filters)
                setSelectedGenre('');
                setSelectedDecade('');
                setSelectedLanguage('');
                setSortBy('popularity');
                setSelectedRuntime('');
                setSelectedRating('');
                setMinImdbRating(0);
                
                if (suggestion.type === 'actor') {
                    // Search for movies with this actor
                    setSearchQuery(suggestion.title);
                    
                    if (mode === 'local') {
                        await searchByActor(suggestion.id);
                    } else {
                        await searchByActorOnline(suggestion.id);
                    }
                } else {
                    // Regular movie search - explicitly start fresh
                    setSearchQuery(suggestion.title);
                    if (mode === 'local') {
                        searchMoviesLocal(suggestion.title, 1, false); // Explicitly page 1, no append
                    } else {
                        searchMoviesOnline(suggestion.title, 1, false); // Explicitly page 1, no append
                    }
                }
            };

            const searchByActor = async (actorId) => {
                setLoading(true);
                try {
                    const response = await fetch(
                        `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&with_cast=${actorId}&sort_by=popularity.desc`
                    );
                    const data = await response.json();
                    const movieList = data.results || [];
                    
                    const moviesWithProviders = [];
                    for (const movie of movieList.slice(0, 20)) {
                        const providers = await fetchStreamingProviders(movie.id);
                        moviesWithProviders.push({
                            ...movie,
                            streamingProviders: providers
                        });
                    }
                    
                    setMovies(moviesWithProviders);
                    setCurrentPage(1);
                    setHasMorePages(data.total_pages > 1);
                    setHasLocalSearchResults(true); // Mark as search result
                } catch (error) {
                    console.error('Error searching by actor:', error);
                }
                setLoading(false);
            };

            const searchByActorOnline = async (actorId) => {
                // Actor search results are LOCAL to each user
                setLoading(true);
                try {
                    const response = await fetch(
                        `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&with_cast=${actorId}&sort_by=popularity.desc`
                    );
                    const data = await response.json();
                    const movieList = data.results || [];
                    
                    const moviesWithProviders = [];
                    for (const movie of movieList.slice(0, 20)) {
                        const providers = await fetchStreamingProviders(movie.id);
                        moviesWithProviders.push({
                            ...movie,
                            streamingProviders: providers
                        });
                    }
                    
                    // Store locally, don't sync to Firebase
                    setMovies(moviesWithProviders);
                    setCurrentPage(1);
                    setHasMorePages(data.total_pages > 1);
                    setHasLocalSearchResults(true); // Mark as local search
                } catch (error) {
                    console.error('Error searching by actor:', error);
                }
                setLoading(false);
            };

            const fetchStreamingProviders = async (movieId) => {
                try {
                    const response = await fetch(
                        `${TMDB_BASE_URL}/movie/${movieId}/watch/providers?api_key=${TMDB_API_KEY}`
                    );
                    const data = await response.json();
                    return data.results?.US || null;
                } catch (error) {
                    console.error('Error fetching streaming providers:', error);
                    return null;
                }
            };

            // User Profile & Watchlist Functions
            const loadUserProfile = (username) => {
                const profiles = JSON.parse(localStorage.getItem('filmi_profiles') || '{}');
                return profiles[username] || { username, email: '', password: '', watchlist: {}, photo: null };
            };

            const saveUserProfile = (profile) => {
                const profiles = JSON.parse(localStorage.getItem('filmi_profiles') || '{}');
                profiles[profile.username] = profile;
                localStorage.setItem('filmi_profiles', JSON.stringify(profiles));
                localStorage.setItem('filmi_current_user', profile.username); // Save current user for persistence
                setUserProfile(profile);
            };

            const loginProfile = (username) => {
                if (!username.trim()) return;
                const profile = loadUserProfile(username.trim());
                setUserProfile(profile);
                saveUserProfile(profile);
                setProfileLoginInput('');
            };


            const logoutProfile = () => {
                setUserProfile(null);
                localStorage.removeItem('filmi_current_user'); // Clear saved login
                setShowProfileMenu(false);
                setScreen('lobby');
            };

            const uploadProfilePhoto = (file) => {
                if (!file || !userProfile) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const updatedProfile = {
                        ...userProfile,
                        photo: e.target.result // base64 string
                    };
                    saveUserProfile(updatedProfile);
                };
                reader.readAsDataURL(file);
            };

            const removeProfilePhoto = () => {
                if (!userProfile) return;
                const updatedProfile = {
                    ...userProfile,
                    photo: null
                };
                saveUserProfile(updatedProfile);
            };

            const addToWatchlist = (movieId, status) => {
                // status: 'seen' or 'want'
                if (!userProfile) return;
                
                const updatedProfile = {
                    ...userProfile,
                    watchlist: {
                        ...userProfile.watchlist,
                        [movieId]: status
                    }
                };
                saveUserProfile(updatedProfile);
            };

            const removeFromWatchlist = (movieId) => {
                if (!userProfile) return;
                
                const updatedProfile = {
                    ...userProfile,
                    watchlist: { ...userProfile.watchlist }
                };
                delete updatedProfile.watchlist[movieId];
                saveUserProfile(updatedProfile);
            };

            const getWatchlistStatus = (movieId) => {
                if (!userProfile) return null;
                return userProfile.watchlist[movieId] || null;
            };

            const getWatchlistMovies = (status) => {
                // status: 'seen', 'want', or null for all
                if (!userProfile) return [];
                const watchlist = userProfile.watchlist;
                return Object.entries(watchlist)
                    .filter(([id, s]) => !status || s === status)
                    .map(([id]) => parseInt(id));
            };

            const startLocalSession = () => {
                setMode('local');
                setScreen('session');
                fetchPopularMoviesLocal();
            };

            const createOnlineSession = async () => {
                if (!userName.trim()) {
                    setError('Please enter your name');
                    return;
                }

                if (!firebaseInitialized) {
                    setError('Firebase is not configured. Use Local Mode instead.');
                    return;
                }

                const code = generateRoomCode();
                setRoomCode(code);
                
                try {
                    await database.ref(`sessions/${code}`).set({
                        host: userName.trim(),
                        users: {
                            [userName.trim()]: {
                                name: userName.trim(),
                                joinedAt: Date.now()
                            }
                        },
                        favorites: {},           // {movieId: {userName: true}}
                        favoritesSubmitted: {},  // {userName: true} - who submitted favorites
                        rankedVotes: {},         // {userName: {first: movieId, second: movieId, third: movieId}}
                        rankedSubmitted: {},     // {userName: true} - who submitted ranked votes
                        votingPhase: VOTING_PHASES.BROWSING,
                        currentPage: 1,
                        hasMorePages: true,
                        largeGroupMode: false,   // Toggle for 1 vs 3 favorites
                        movies: {},
                        createdAt: Date.now()
                    });

                    setMode('online');
                    setScreen('session');
                    setError('');
                    fetchPopularMoviesOnline(code);
                } catch (err) {
                    setError('Failed to create session: ' + err.message);
                }
            };

            const joinOnlineSession = async () => {
                if (!userName.trim()) {
                    setError('Please enter your name');
                    return;
                }

                if (!joinCode.trim()) {
                    setError('Please enter a room code');
                    return;
                }

                if (!firebaseInitialized) {
                    setError('Firebase is not configured. Cannot join online sessions.');
                    return;
                }

                const code = joinCode.trim().toUpperCase();
                
                try {
                    const sessionRef = database.ref(`sessions/${code}`);
                    const snapshot = await sessionRef.once('value');
                    
                    if (!snapshot.exists()) {
                        setError('Room not found. Please check the code.');
                        return;
                    }

                    await sessionRef.child(`users/${userName.trim()}`).set({
                        name: userName.trim(),
                        joinedAt: Date.now()
                    });

                    setRoomCode(code);
                    setMode('online');
                    setScreen('session');
                    setError('');
                } catch (err) {
                    setError('Failed to join session: ' + err.message);
                }
            };

            const leaveSession = () => {
                if (mode === 'online' && firebaseInitialized && roomCode && userName) {
                    database.ref(`sessions/${roomCode}/users/${userName}`).remove();
                }
                setScreen('lobby');
                setMode('');
                setRoomCode('');
                setSessionData(null);
                setMovies([]);
                setLocalUsers([]);
                setLocalFavorites({});
                setLocalRankedVotes({});
                setLocalVotingPhase(VOTING_PHASES.BROWSING);
                setLargeGroupMode(false);
                setCurrentVoterIndex(0);
                setLocalFavoritesSubmitted([]);
                setLocalRankedSubmitted([]);
            };

            const addLocalUser = () => {
                if (newUserName.trim() && !localUsers.includes(newUserName.trim())) {
                    setLocalUsers([...localUsers, newUserName.trim()]);
                    setNewUserName('');
                }
            };

            const removeLocalUser = (userName) => {
                setLocalUsers(localUsers.filter(u => u !== userName));
                // Remove user's favorites
                const newFavorites = { ...localFavorites };
                Object.keys(newFavorites).forEach(movieId => {
                    delete newFavorites[movieId]?.[userName];
                    if (Object.keys(newFavorites[movieId] || {}).length === 0) {
                        delete newFavorites[movieId];
                    }
                });
                setLocalFavorites(newFavorites);
                // Remove user's ranked votes
                const newRankedVotes = { ...localRankedVotes };
                delete newRankedVotes[userName];
                setLocalRankedVotes(newRankedVotes);
            };

            const fetchPopularMoviesLocal = async (page = 1, append = false) => {
                setLoading(true);
                try {
                    const response = await fetch(
                        `${TMDB_BASE_URL}/movie/popular?api_key=${TMDB_API_KEY}&page=${page}`
                    );
                    const data = await response.json();
                    const movieList = data.results || [];
                    
                    // Fetch streaming providers for each movie
                    const moviesWithProviders = [];
                    for (const movie of movieList) {
                        const providers = await fetchStreamingProviders(movie.id);
                        moviesWithProviders.push({
                            ...movie,
                            streamingProviders: providers
                        });
                    }
                    
                    setMovies(append ? [...movies, ...moviesWithProviders] : moviesWithProviders);
                    setCurrentPage(page);
                    setHasMorePages(page < data.total_pages);
                } catch (error) {
                    console.error('Error fetching movies:', error);
                }
                setLoading(false);
            };

            const fetchPopularMoviesOnline = async (code, page = 1, append = false) => {
                setLoading(true);
                try {
                    const response = await fetch(
                        `${TMDB_BASE_URL}/movie/popular?api_key=${TMDB_API_KEY}&page=${page}`
                    );
                    const data = await response.json();
                    const movieList = data.results || [];
                    
                    if (firebaseInitialized) {
                        const moviesObj = {};
                        
                        for (const movie of movieList) {
                            const providers = await fetchStreamingProviders(movie.id);
                            moviesObj[movie.id] = {
                                ...movie,
                                streamingProviders: providers
                            };
                        }
                        
                        if (append) {
                            await database.ref(`sessions/${code}/movies`).update(moviesObj);
                        } else {
                            await database.ref(`sessions/${code}/movies`).set(moviesObj);
                        }
                        await database.ref(`sessions/${code}/currentPage`).set(page);
                        await database.ref(`sessions/${code}/hasMorePages`).set(page < data.total_pages);
                    }
                } catch (error) {
                    console.error('Error fetching movies:', error);
                }
                setLoading(false);
            };

            const loadMoreMovies = () => {
                if (loading) return; // Prevent double-loading
                
                if (mode === 'local') {
                    // If we have a search query or filters, load more with those
                    if (searchQuery || selectedGenre || selectedDecade || selectedLanguage || sortBy !== 'popularity') {
                        searchMoviesLocal(searchQuery, currentPage + 1, true);
                    } else {
                        fetchPopularMoviesLocal(currentPage + 1, true);
                    }
                } else if (mode === 'online') {
                    // In online mode, check if host has search results
                    if (hasLocalSearchResults) {
                        searchMoviesOnline(searchQuery, currentPage + 1, true);
                    } else {
                        fetchPopularMoviesOnline(roomCode, (sessionData?.currentPage || 1) + 1, true);
                    }
                }
            };

            const resetToHome = () => {
                // Reset all search filters
                setSearchQuery('');
                setSelectedGenre('');
                setSelectedDecade('');
                setSelectedLanguage('');
                setSortBy('popularity');
                
                // Reset advanced filters
                setSelectedRuntime('');
                setSelectedRating('');
                setSelectedStreamingServices([]);
                setMinImdbRating(0);
                setYearRange({ min: 1970, max: new Date().getFullYear() });
                
                setShowSuggestions(false);
                setSearchSuggestions([]);
                setHasLocalSearchResults(false);
                
                // Load popular movies
                if (mode === 'local') {
                    fetchPopularMoviesLocal();
                } else if (mode === 'online') {
                    // In online mode, just clear local search results to show synced movies
                    setHasLocalSearchResults(false);
                }
            };

            const searchMoviesLocal = async (customQuery = null, page = 1, append = false) => {
                const query = customQuery || searchQuery;
                setShowSuggestions(false); // Hide suggestions when searching
                
                if (!query.trim() && !selectedGenre && !selectedDecade && !selectedLanguage && sortBy === 'popularity') {
                    fetchPopularMoviesLocal();
                    return;
                }

                setLoading(true);
                try {
                    // Always use discover/movie for combined filtering
                    let url = `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&page=${page}`;
                    
                    // Handle sort by
                    if (sortBy === 'new_releases') {
                        const sixMonthsAgo = new Date();
                        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                        const dateString = sixMonthsAgo.toISOString().split('T')[0];
                        url += `&primary_release_date.gte=${dateString}&sort_by=primary_release_date.desc`;
                    } else if (sortBy === 'highest_rated') {
                        url += `&vote_average.gte=7&vote_count.gte=100&sort_by=vote_average.desc`;
                    } else {
                        url += `&sort_by=popularity.desc`;
                    }
                    
                    // Add query as keyword search if provided
                    if (query.trim()) {
                        // Use search endpoint if query is provided without other filters
                        if (!selectedGenre && !selectedDecade && !selectedLanguage && sortBy === 'popularity') {
                            url = `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&include_adult=false&page=${page}`;
                        } else {
                            // With other filters, search then filter (pagination supported!)
                            const searchResponse = await fetch(
                                `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&include_adult=false&page=${page}`
                            );
                            const searchData = await searchResponse.json();
                            const searchIds = (searchData.results || []).map(m => m.id);
                            
                            // Now fetch with filters and filter to searched movie IDs
                            const response = await fetch(url + 
                                (selectedGenre ? `&with_genres=${selectedGenre}` : '') +
                                (selectedDecade ? `&primary_release_date.gte=${selectedDecade.split('-')[0]}-01-01&primary_release_date.lte=${selectedDecade.split('-')[1]}-12-31` : '') +
                                (selectedLanguage ? `&with_original_language=${selectedLanguage}` : '')
                            );
                            const data = await response.json();
                            const movieList = (data.results || []).filter(m => searchIds.includes(m.id));
                            
                            const moviesWithProviders = [];
                            for (const movie of movieList) {
                                const providers = await fetchStreamingProviders(movie.id);
                                moviesWithProviders.push({
                                    ...movie,
                                    streamingProviders: providers
                                });
                            }
                            
                            setMovies(append ? [...movies, ...moviesWithProviders] : moviesWithProviders);
                            setCurrentPage(page);
                            setHasMorePages(searchData.page < searchData.total_pages && movieList.length > 0);
                            setHasLocalSearchResults(true);
                            setLoading(false);
                            return;
                        }
                    }
                    
                    // Add filters (when no query or query-only search)
                    if (selectedGenre) {
                        url += `&with_genres=${selectedGenre}`;
                    }
                    
                    if (selectedDecade) {
                        const [start, end] = selectedDecade.split('-');
                        url += `&primary_release_date.gte=${start}-01-01&primary_release_date.lte=${end}-12-31`;
                    }

                    if (selectedLanguage) {
                        url += `&with_original_language=${selectedLanguage}`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();
                    const movieList = data.results || [];

                    const moviesWithProviders = [];
                    for (const movie of movieList) {
                        const providers = await fetchStreamingProviders(movie.id);
                        moviesWithProviders.push({
                            ...movie,
                            streamingProviders: providers
                        });
                    }
                    
                    setMovies(append ? [...movies, ...moviesWithProviders] : moviesWithProviders);
                    setCurrentPage(page);
                    setHasMorePages(data.page < data.total_pages);
                    setHasLocalSearchResults(true);
                } catch (error) {
                    console.error('Error searching movies:', error);
                }
                setLoading(false);
            };

            const searchMoviesOnline = async (customQuery = null, page = 1, append = false) => {
                // Search results are LOCAL to each user - don't sync to Firebase
                const query = customQuery || searchQuery;
                setShowSuggestions(false); // Hide suggestions when searching

                setLoading(true);
                try {
                    // Always use discover/movie for combined filtering
                    let url = `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&page=${page}`;
                    
                    // Handle sort by
                    if (sortBy === 'new_releases') {
                        const sixMonthsAgo = new Date();
                        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                        const dateString = sixMonthsAgo.toISOString().split('T')[0];
                        url += `&primary_release_date.gte=${dateString}&sort_by=primary_release_date.desc`;
                    } else if (sortBy === 'highest_rated') {
                        url += `&vote_average.gte=7&vote_count.gte=100&sort_by=vote_average.desc`;
                    } else {
                        url += `&sort_by=popularity.desc`;
                    }
                    
                    // Add query as keyword search if provided
                    if (query.trim()) {
                        // Use search endpoint if query is provided without other filters
                        if (!selectedGenre && !selectedDecade && !selectedLanguage && sortBy === 'popularity') {
                            url = `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&include_adult=false&page=${page}`;
                        } else {
                            // With other filters, search first then filter results
                            const searchResponse = await fetch(
                                `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&include_adult=false&page=${page}`
                            );
                            const searchData = await searchResponse.json();
                            const searchIds = (searchData.results || []).map(m => m.id);
                            
                            // Now fetch with filters and filter to searched movie IDs
                            const response = await fetch(url + 
                                (selectedGenre ? `&with_genres=${selectedGenre}` : '') +
                                (selectedDecade ? `&primary_release_date.gte=${selectedDecade.split('-')[0]}-01-01&primary_release_date.lte=${selectedDecade.split('-')[1]}-12-31` : '') +
                                (selectedLanguage ? `&with_original_language=${selectedLanguage}` : '')
                            );
                            const data = await response.json();
                            const movieList = (data.results || []).filter(m => searchIds.includes(m.id));
                            
                            const moviesWithProviders = [];
                            for (const movie of movieList) {
                                const providers = await fetchStreamingProviders(movie.id);
                                moviesWithProviders.push({
                                    ...movie,
                                    streamingProviders: providers
                                });
                            }
                            
                            setMovies(append ? [...movies, ...moviesWithProviders] : moviesWithProviders);
                            setCurrentPage(page);
                            setHasMorePages(searchData.page < searchData.total_pages && movieList.length > 0);
                            setHasLocalSearchResults(true);
                            setLoading(false);
                            return;
                        }
                    }
                    
                    // Add filters (when no query or query-only search)
                    if (selectedGenre) {
                        url += `&with_genres=${selectedGenre}`;
                    }
                    
                    if (selectedDecade) {
                        const [start, end] = selectedDecade.split('-');
                        url += `&primary_release_date.gte=${start}-01-01&primary_release_date.lte=${end}-12-31`;
                    }

                    if (selectedLanguage) {
                        url += `&with_original_language=${selectedLanguage}`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();
                    const movieList = data.results || [];

                    const moviesWithProviders = [];
                    for (const movie of movieList) {
                        const providers = await fetchStreamingProviders(movie.id);
                        moviesWithProviders.push({
                            ...movie,
                            streamingProviders: providers
                        });
                    }
                    
                    // Store locally, don't sync to Firebase
                    setMovies(append ? [...movies, ...moviesWithProviders] : moviesWithProviders);
                    setCurrentPage(page);
                    setHasMorePages(data.page < data.total_pages);
                    setHasLocalSearchResults(true); // Mark as local search
                } catch (error) {
                    console.error('Error searching movies:', error);
                }
                setLoading(false);
            };

            const handleFavoriteLocal = (movieId, userName) => {
                const maxFavorites = largeGroupMode ? 1 : 3;
                
                setLocalFavorites(prev => {
                    const userFavorites = Object.entries(prev).filter(([id, users]) => users[userName]).map(([id]) => id);
                    
                    if (prev[movieId]?.[userName]) {
                        // Remove favorite
                        const newFavorites = { ...prev };
                        delete newFavorites[movieId][userName];
                        if (Object.keys(newFavorites[movieId]).length === 0) {
                            delete newFavorites[movieId];
                        }
                        return newFavorites;
                    } else if (userFavorites.length < maxFavorites) {
                        // Add favorite
                        return {
                            ...prev,
                            [movieId]: {
                                ...prev[movieId],
                                [userName]: true
                            }
                        };
                    }
                    return prev; // Already at max favorites
                });
            };

            const proceedToFinalVoteLocal = () => {
                setLocalVotingPhase(VOTING_PHASES.FINAL_VOTE);
            };

            const handleRankedVoteLocal = (userName, rank, movieId) => {
                // rank is 'first', 'second', or 'third'
                setLocalRankedVotes(prev => ({
                    ...prev,
                    [userName]: {
                        ...prev[userName],
                        [rank]: movieId
                    }
                }));
            };

            const announceWinnerLocal = () => {
                setLocalVotingPhase(VOTING_PHASES.WINNER);
            };

            const handleFavoriteOnline = async (movieId) => {
                if (!firebaseInitialized) return;

                const maxFavorites = sessionData?.largeGroupMode ? 1 : 3;
                const userFavorites = Object.entries(sessionData?.favorites || {})
                    .filter(([id, users]) => users[userName])
                    .map(([id]) => id);

                const currentFavorite = sessionData?.favorites?.[movieId]?.[userName];
                
                if (currentFavorite) {
                    // Remove favorite
                    await database.ref(`sessions/${roomCode}/favorites/${movieId}/${userName}`).remove();
                } else if (userFavorites.length < maxFavorites) {
                    // Add favorite
                    await database.ref(`sessions/${roomCode}/favorites/${movieId}/${userName}`).set(true);
                    
                    // IMPORTANT: Also add the movie data to Firebase so everyone can see it
                    // Find the movie in the current movies array
                    const movie = movies.find(m => m.id === movieId);
                    if (movie) {
                        // Add to Firebase movies if not already there
                        await database.ref(`sessions/${roomCode}/movies/${movieId}`).set(movie);
                    }
                }
            };

            const proceedToFinalVoteOnline = async () => {
                if (!firebaseInitialized) return;
                await database.ref(`sessions/${roomCode}/votingPhase`).set(VOTING_PHASES.FINAL_VOTE);
            };

            const removeParticipant = async (participantName) => {
                if (!firebaseInitialized || !roomCode) return;
                if (userName !== sessionData?.host) {
                    alert('Only the host can remove participants!');
                    return;
                }
                
                if (participantName === sessionData?.host) {
                    alert('Cannot remove the host!');
                    return;
                }
                
                if (window.confirm(`Remove ${participantName} from the session?`)) {
                    // Remove from users
                    await database.ref(`sessions/${roomCode}/users/${participantName}`).remove();
                    
                    // Remove their favorites
                    const favoritesRef = database.ref(`sessions/${roomCode}/favorites`);
                    const favoritesSnapshot = await favoritesRef.once('value');
                    const favorites = favoritesSnapshot.val() || {};
                    
                    for (const movieId in favorites) {
                        if (favorites[movieId][participantName]) {
                            await database.ref(`sessions/${roomCode}/favorites/${movieId}/${participantName}`).remove();
                        }
                    }
                    
                    // Remove their submissions
                    await database.ref(`sessions/${roomCode}/favoritesSubmitted/${participantName}`).remove();
                    await database.ref(`sessions/${roomCode}/rankedSubmitted/${participantName}`).remove();
                    
                    // Remove their votes
                    await database.ref(`sessions/${roomCode}/rankedVotes/${participantName}`).remove();
                }
            };

            const handleRankedVoteOnline = async (rank, movieId) => {
                if (!firebaseInitialized) return;
                // rank is 'first', 'second', or 'third'
                await database.ref(`sessions/${roomCode}/rankedVotes/${userName}/${rank}`).set(movieId);
            };

            const announceWinnerOnline = async () => {
                if (!firebaseInitialized) return;
                
                // Calculate winner before announcing
                const scores = calculateRankedScores();
                const winnerId = Object.entries(scores)
                    .sort((a, b) => b[1] - a[1])[0]?.[0];
                
                // Get winner from session movies (not local filtered list)
                const sessionMovies = sessionData?.movies ? Object.values(sessionData.movies) : [];
                const winnerMovie = sessionMovies.find(m => m.id === parseInt(winnerId));
                
                if (winnerMovie) {
                    // Save winner data to Firebase so all users can see it
                    await database.ref(`sessions/${roomCode}/winner`).set({
                        ...winnerMovie,
                        score: scores[winnerId]
                    });
                }
                
                // Set phase to winner
                await database.ref(`sessions/${roomCode}/votingPhase`).set(VOTING_PHASES.WINNER);
            };

            const toggleLargeGroupMode = async () => {
                if (mode === 'local') {
                    setLargeGroupMode(!largeGroupMode);
                } else if (mode === 'online' && firebaseInitialized) {
                    await database.ref(`sessions/${roomCode}/largeGroupMode`).set(!sessionData?.largeGroupMode);
                }
            };

            const openMovieDetails = async (movie) => {
                if (!movie || !movie.id) {
                    console.error('Invalid movie data:', movie);
                    return;
                }
                console.log('Opening details for:', movie.title);
                setSelectedMovie(movie);
                const details = await fetchMovieDetails(movie.id);
                console.log('Fetched details:', details);
                setMovieDetails(details);
            };

            const closeMovieDetails = () => {
                setSelectedMovie(null);
                setMovieDetails(null);
            };

            // Submit votes functions
            const submitFavoritesLocal = (userName) => {
                if (!localFavoritesSubmitted.includes(userName)) {
                    setLocalFavoritesSubmitted([...localFavoritesSubmitted, userName]);
                }
            };

            const submitRankedVotesLocal = (userName) => {
                if (!localRankedSubmitted.includes(userName)) {
                    setLocalRankedSubmitted([...localRankedSubmitted, userName]);
                }
            };

            const submitFavoritesOnline = async () => {
                if (!firebaseInitialized) return;
                await database.ref(`sessions/${roomCode}/favoritesSubmitted/${userName}`).set(true);
            };

            const submitRankedVotesOnline = async () => {
                if (!firebaseInitialized) return;
                await database.ref(`sessions/${roomCode}/rankedSubmitted/${userName}`).set(true);
            };

            const getSubmittedCount = (phase) => {
                if (mode === 'local') {
                    return phase === 'favorites' ? localFavoritesSubmitted.length : localRankedSubmitted.length;
                } else {
                    const submitted = phase === 'favorites' 
                        ? sessionData?.favoritesSubmitted || {}
                        : sessionData?.rankedSubmitted || {};
                    return Object.keys(submitted).length;
                }
            };

            const hasUserSubmitted = (phase, user) => {
                if (mode === 'local') {
                    return phase === 'favorites' 
                        ? localFavoritesSubmitted.includes(user)
                        : localRankedSubmitted.includes(user);
                } else {
                    const submitted = phase === 'favorites'
                        ? sessionData?.favoritesSubmitted || {}
                        : sessionData?.rankedSubmitted || {};
                    return !!submitted[user || userName];
                }
            };

            const getUserFavoriteCount = (userName) => {
                if (mode === 'local') {
                    return Object.entries(localFavorites).filter(([id, users]) => users[userName]).length;
                } else {
                    return Object.entries(sessionData?.favorites || {}).filter(([id, users]) => users[userName]).length;
                }
            };

            const getMovieFavoriteCount = (movieId) => {
                if (mode === 'local') {
                    return Object.keys(localFavorites[movieId] || {}).length;
                } else {
                    return Object.keys(sessionData?.favorites?.[movieId] || {}).length;
                }
            };

            const getFavoritedMovies = () => {
                const favorites = mode === 'local' ? localFavorites : sessionData?.favorites || {};
                const favoritedIds = Object.keys(favorites).map(id => parseInt(id));
                
                // For online mode, we need to include ALL favorited movies from Firebase
                // not just what's in the local movies array (which might be from a search)
                if (mode === 'online' && sessionData?.movies) {
                    const allSessionMovies = Object.values(sessionData.movies);
                    return allSessionMovies.filter(m => favoritedIds.includes(m.id));
                }
                
                // For local mode, filter from current movies array
                return movies.filter(m => favoritedIds.includes(m.id));
            };

            const getUserRankedVotes = (userName) => {
                if (mode === 'local') {
                    return localRankedVotes[userName] || {};
                } else {
                    return sessionData?.rankedVotes?.[userName] || {};
                }
            };

            const calculateRankedScores = () => {
                const rankedVotes = mode === 'local' ? localRankedVotes : sessionData?.rankedVotes || {};
                const scores = {};
                
                Object.values(rankedVotes).forEach(userVotes => {
                    if (userVotes.first) scores[userVotes.first] = (scores[userVotes.first] || 0) + RANKED_VOTE_POINTS.first;
                    if (userVotes.second) scores[userVotes.second] = (scores[userVotes.second] || 0) + RANKED_VOTE_POINTS.second;
                    if (userVotes.third) scores[userVotes.third] = (scores[userVotes.third] || 0) + RANKED_VOTE_POINTS.third;
                });
                
                return scores;
            };

            const getWinner = () => {
                const phase = mode === 'local' ? localVotingPhase : sessionData?.votingPhase;
                if (phase !== VOTING_PHASES.WINNER) return null;

                // In online mode, use the winner saved in Firebase
                if (mode === 'online' && sessionData?.winner) {
                    return sessionData.winner;
                }

                // In local mode, calculate from current movies
                const scores = calculateRankedScores();
                const winnerId = Object.entries(scores)
                    .sort((a, b) => b[1] - a[1])[0]?.[0];

                const winner = movies.find(m => m.id === parseInt(winnerId));
                return winner ? { ...winner, score: scores[winnerId] } : null;
            };

            const getRankedResults = () => {
                const scores = calculateRankedScores();
                return getFavoritedMovies()
                    .map(movie => ({
                        ...movie,
                        score: scores[movie.id] || 0
                    }))
                    .sort((a, b) => b.score - a.score);
            };

            // Generate streaming platform link
            const getStreamingLink = (movie, provider) => {
                // Map of provider IDs to their base URLs and search patterns
                const providerLinks = {
                    8: { name: 'Netflix', url: 'https://www.netflix.com/search?q=' }, // Netflix
                    9: { name: 'Amazon Prime', url: 'https://www.amazon.com/s?k=' }, // Amazon Prime
                    10: { name: 'Apple TV', url: 'https://tv.apple.com/search?q=' }, // Apple TV+
                    15: { name: 'Hulu', url: 'https://www.hulu.com/search?q=' }, // Hulu
                    337: { name: 'Disney+', url: 'https://www.disneyplus.com/search?q=' }, // Disney+
                    384: { name: 'HBO Max', url: 'https://www.max.com/search?q=' }, // HBO Max/Max
                    387: { name: 'Peacock', url: 'https://www.peacocktv.com/search?q=' }, // Peacock
                    531: { name: 'Paramount+', url: 'https://www.paramountplus.com/search/?query=' }, // Paramount+
                    350: { name: 'Apple TV', url: 'https://tv.apple.com/search?q=' }, // Apple TV (buy/rent)
                    2: { name: 'Apple TV', url: 'https://tv.apple.com/search?q=' }, // Apple iTunes
                    3: { name: 'Google Play', url: 'https://play.google.com/store/search?q=' }, // Google Play
                    192: { name: 'YouTube', url: 'https://www.youtube.com/results?search_query=' }, // YouTube
                };

                const providerInfo = providerLinks[provider.provider_id];
                if (providerInfo) {
                    // Use movie title for search
                    const searchQuery = encodeURIComponent(movie.title);
                    return providerInfo.url + searchQuery;
                }

                // Fallback: Google search for the movie + provider
                return `https://www.google.com/search?q=${encodeURIComponent(movie.title + ' ' + provider.provider_name)}`;
            };

            const getVotingBreakdown = (movieId) => {
                // Get who voted for this movie and at what rank
                const rankedVotes = mode === 'local' ? localRankedVotes : sessionData?.rankedVotes || {};
                const breakdown = {
                    first: [],
                    second: [],
                    third: []
                };

                Object.entries(rankedVotes).forEach(([userName, votes]) => {
                    if (votes.first === movieId) breakdown.first.push(userName);
                    if (votes.second === movieId) breakdown.second.push(userName);
                    if (votes.third === movieId) breakdown.third.push(userName);
                });

                return breakdown;
            };

            const users = mode === 'local' 
                ? localUsers 
                : (sessionData?.users ? Object.values(sessionData.users) : []);

            const copyRoomCode = () => {
                navigator.clipboard.writeText(roomCode);
                alert('Room code copied to clipboard!');
            };

            // Generate shareable session link
            const generateSessionLink = () => {
                const baseUrl = window.location.origin + window.location.pathname;
                return `${baseUrl}?join=${roomCode}`;
            };

            // Copy session link to clipboard
            const copySessionLink = () => {
                const link = generateSessionLink();
                navigator.clipboard.writeText(link);
                alert('Session link copied! Share it with friends to join instantly.');
            };

            // Generate QR code data URL for session
            const generateQRCode = () => {
                // Using a simple QR code generation approach
                // In production, you'd use a library like qrcode.js
                const link = generateSessionLink();
                // For now, use a QR code API service
                return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(link)}`;
            };

            // Export watchlist as text (basis for PDF)
            const exportWatchlist = () => {
                if (!userProfile || !userProfile.watchlist) {
                    alert('No watchlist to export!');
                    return;
                }

                const watchlistMovies = movies.filter(m => userProfile.watchlist[m.id]);
                
                if (watchlistMovies.length === 0) {
                    alert('Your watchlist is empty!');
                    return;
                }

                let exportText = ` ${userProfile.username}'s Watchlist\n`;
                exportText += `Generated: ${new Date().toLocaleDateString()}\n\n`;
                
                const seenMovies = watchlistMovies.filter(m => userProfile.watchlist[m.id] === 'seen');
                const wantMovies = watchlistMovies.filter(m => userProfile.watchlist[m.id] === 'want');

                if (seenMovies.length > 0) {
                    exportText += ` WATCHED (${seenMovies.length}):\n`;
                    seenMovies.forEach(m => {
                        exportText += `   ${m.title} (${m.release_date?.substring(0, 4) || 'N/A'})\n`;
                    });
                    exportText += '\n';
                }

                if (wantMovies.length > 0) {
                    exportText += ` WANT TO WATCH (${wantMovies.length}):\n`;
                    wantMovies.forEach(m => {
                        exportText += `   ${m.title} (${m.release_date?.substring(0, 4) || 'N/A'})\n`;
                    });
                }

                // Create downloadable text file
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${userProfile.username}_watchlist.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('Watchlist exported! Check your downloads.');
            };

            // Share session results
            const shareResults = () => {
                const winner = getWinner();
                if (!winner) {
                    alert('No winner yet!');
                    return;
                }

                const rankedResults = getRankedResults();
                let resultsText = ` FILMI Results\n`;
                resultsText += `Session: ${roomCode || 'Local'}\n`;
                resultsText += `Date: ${new Date().toLocaleDateString()}\n\n`;
                resultsText += ` WINNER: ${winner.title}\n`;
                resultsText += `Score: ${winner.score} points\n\n`;
                
                if (rankedResults.length > 1) {
                    resultsText += `Top 3:\n`;
                    rankedResults.slice(0, 3).forEach((movie, idx) => {
                        resultsText += `${idx + 1}. ${movie.title} - ${movie.score} points\n`;
                    });
                }

                navigator.clipboard.writeText(resultsText);
                alert('Results copied to clipboard! Share with your group.');
            };

            // Advanced filtering function
            const applyAdvancedFilters = (moviesList) => {
                return moviesList.filter(movie => {
                    // Runtime filter
                    if (selectedRuntime) {
                        const runtime = movie.runtime || 0;
                        if (selectedRuntime === 'short' && runtime >= 90) return false;
                        if (selectedRuntime === 'medium' && (runtime < 90 || runtime >= 150)) return false;
                        if (selectedRuntime === 'long' && runtime < 150) return false;
                    }

                    // Rating filter (content rating like PG-13, R, etc)
                    if (selectedRating && movie.certification) {
                        if (movie.certification !== selectedRating) return false;
                    }

                    // Streaming service filter
                    if (selectedStreamingServices.length > 0 && movie.streamingProviders) {
                        const movieServices = Object.keys(movie.streamingProviders);
                        const hasSelectedService = selectedStreamingServices.some(serviceId => 
                            movieServices.includes(serviceId)
                        );
                        if (!hasSelectedService) return false;
                    }

                    // IMDb rating filter
                    if (minImdbRating > 0) {
                        const rating = movie.vote_average || 0;
                        if (rating < minImdbRating) return false;
                    }

                    // Year range filter
                    if (movie.release_date) {
                        const movieYear = parseInt(movie.release_date.substring(0, 4));
                        if (movieYear < yearRange.min || movieYear > yearRange.max) return false;
                    }

                    return true;
                });
            };

            if (screen === 'lobby') {
                return (
                    <>
                        {/* Profile Toggle Button - only show when not on lobby mode selection */}
                        {mode && (
                            <button 
                                className={`profile-toggle-btn ${selectedMovie ? 'hidden' : ''}`}
                                onClick={() => setIsProfileBarMinimized(!isProfileBarMinimized)}
                                title={isProfileBarMinimized ? 'Show Profile Bar' : 'Hide Profile Bar'}
                            >
                                {isProfileBarMinimized ? '' : ''}
                            </button>
                        )}

                        {/* Profile Bar */}
                        <div className={`profile-bar ${isScrolled ? 'compact' : ''} ${selectedMovie ? 'hidden' : ''} ${isProfileBarMinimized ? 'minimized' : ''}`}>
                            {!userProfile ? (
                                <div className="profile-login">
                                    <input
                                        type="text"
                                        placeholder="Enter your name to login"
                                        value={profileLoginInput}
                                        onChange={(e) => setProfileLoginInput(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') loginProfile(profileLoginInput);
                                        }}
                                    />
                                    <button 
                                        className="profile-btn"
                                        onClick={() => loginProfile(profileLoginInput)}
                                    >
                                        Login
                                    </button>
                                </div>
                            ) : (
                                <div className="profile-header">
                                    {userProfile.photo ? (
                                        <img
                                            src={userProfile.photo}
                                            alt={userProfile.username}
                                            className="profile-avatar"
                                            onClick={() => setScreen('profile')}
                                            title="View Profile"
                                        />
                                    ) : (
                                        <div
                                            className="profile-avatar-placeholder"
                                            onClick={() => setScreen('profile')}
                                            title="View Profile"
                                        >
                                            {userProfile.username.charAt(0).toUpperCase()}
                                        </div>
                                    )}
                                    <span className="profile-name">{userProfile.username}</span>
                                    <button 
                                        className="profile-btn"
                                        onClick={() => setScreen('profile')}
                                    >
                                         My Watchlist
                                    </button>
                                    <button 
                                        className="profile-btn"
                                        onClick={logoutProfile}
                                    >
                                        Logout
                                    </button>
                                </div>
                            )}
                            <div style={{ fontSize: '0.9rem', color: 'var(--accent-gold)' }}>
                                 FILMI
                            </div>
                        </div>

                        <div className="app-container" style={{ paddingTop: isScrolled ? '90px' : '140px', transition: 'padding-top 0.3s ease' }}>
                        <div className="header">
                            <div className="marquee-lights">
                                <div className="light"></div>
                                <div className="light"></div>
                                <div className="light"></div>
                                <div className="light"></div>
                                <div className="light"></div>
                            </div>
                            <h1 className="app-title">FILMI</h1>
                            <p className="app-subtitle">Tonight's Feature Presentation</p>
                        </div>

                        <div className="lobby-section">
                            <h2 className="lobby-title">Choose Your Experience</h2>
                            
                            {error && <div className="error-message">{error}</div>}

                            <div className="mode-selector">
                                <div 
                                    className={`mode-card ${mode === 'local' ? 'selected' : ''}`}
                                    onClick={() => setMode('local')}
                                >
                                    <div className="mode-icon"></div>
                                    <div className="mode-title">Local Session</div>
                                    <div className="mode-description">
                                        Single device. Everyone gathers around to vote. No setup required.
                                    </div>
                                </div>

                                <div 
                                    className={`mode-card ${mode === 'online' ? 'selected' : ''}`}
                                    onClick={() => setMode('online')}
                                >
                                    <div className="mode-icon"></div>
                                    <div className="mode-title">Online Session</div>
                                    <div className="mode-description">
                                        Multi-device. Everyone votes from their own phone. {!firebaseInitialized && 'Requires Firebase setup.'}
                                    </div>
                                </div>
                            </div>

                            {mode === 'local' && (
                                <>
                                    <button onClick={startLocalSession}>
                                        Start Local Session
                                    </button>
                                </>
                            )}

                            {mode === 'online' && (
                                <>
                                    {!firebaseInitialized && (
                                        <div className="error-message">
                                            Firebase not configured. Please add your Firebase config to use online sessions, or use Local Mode.
                                        </div>
                                    )}
                                    
                                    <div className="input-group">
                                        <label>Your Name</label>
                                        <input
                                            type="text"
                                            placeholder="Enter your name..."
                                            value={userName}
                                            onChange={(e) => setUserName(e.target.value)}
                                        />
                                    </div>

                                    <button onClick={createOnlineSession} disabled={!userName.trim() || !firebaseInitialized}>
                                        Create Online Session
                                    </button>

                                    <div className="divider">
                                        <span>OR</span>
                                    </div>

                                    <div className="input-group">
                                        <label>Room Code</label>
                                        <input
                                            type="text"
                                            placeholder="Enter 6-digit code..."
                                            value={joinCode}
                                            onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                                            maxLength="6"
                                        />
                                    </div>

                                    <button 
                                        onClick={joinOnlineSession} 
                                        className="btn-secondary" 
                                        disabled={!userName.trim() || !joinCode.trim() || !firebaseInitialized}
                                    >
                                        Join Online Session
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    </>
                );
            }

            // Profile/Watchlist Screen
            if (screen === 'profile' && userProfile) {
                return (
                    <>
                        {/* Profile Bar */}
                        <div className={`profile-bar ${isScrolled ? 'compact' : ''} ${selectedMovie ? 'hidden' : ''}`}>
                            <div className="profile-header">
                                {userProfile.photo ? (
                                    <img
                                        src={userProfile.photo}
                                        alt={userProfile.username}
                                        className="profile-avatar"
                                    />
                                ) : (
                                    <div className="profile-avatar-placeholder">
                                        {userProfile.username.charAt(0).toUpperCase()}
                                    </div>
                                )}
                                <span className="profile-name">{userProfile.username}</span>
                                <button 
                                    className="profile-btn"
                                    onClick={() => setScreen('lobby')}
                                >
                                     Back to Lobby
                                </button>
                                <button 
                                    className="profile-btn"
                                    onClick={logoutProfile}
                                >
                                    Logout
                                </button>
                            </div>
                            <div style={{ fontSize: '0.9rem', color: 'var(--accent-gold)' }}>
                                 FILMI
                            </div>
                        </div>

                        <div className="profile-screen">
                            <div className="profile-screen-header">
                                <h1 style={{ 
                                    fontSize: '2.5rem', 
                                    color: 'var(--accent-gold)',
                                    fontFamily: "'Playfair Display', serif",
                                    marginBottom: '10px'
                                }}>
                                    {userProfile.username}'s Profile
                                </h1>
                                
                                <div className="profile-photo-section">
                                    {userProfile.photo ? (
                                        <img
                                            src={userProfile.photo}
                                            alt={userProfile.username}
                                            className="profile-photo-large"
                                        />
                                    ) : (
                                        <div className="profile-photo-placeholder-large">
                                            {userProfile.username.charAt(0).toUpperCase()}
                                        </div>
                                    )}
                                    
                                    <input
                                        type="file"
                                        accept="image/*"
                                        className="photo-upload-btn"
                                        id="photo-upload"
                                        onChange={(e) => {
                                            if (e.target.files[0]) {
                                                uploadProfilePhoto(e.target.files[0]);
                                            }
                                        }}
                                    />
                                    
                                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', justifyContent: 'center' }}>
                                        <button 
                                            className="profile-btn"
                                            onClick={() => document.getElementById('photo-upload').click()}
                                        >
                                             {userProfile.photo ? 'Change Photo' : 'Upload Photo'}
                                        </button>
                                        
                                        {userProfile.photo && (
                                            <button 
                                                className="profile-btn"
                                                style={{ borderColor: 'var(--accent-red)', color: 'var(--accent-red)' }}
                                                onClick={removeProfilePhoto}
                                            >
                                                Remove Photo
                                            </button>
                                        )}
                                        
                                        <button 
                                            className="profile-btn"
                                            style={{ background: 'var(--accent-gold)', color: '#000' }}
                                            onClick={exportWatchlist}
                                        >
                                             Export Watchlist
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <h2 style={{ 
                                textAlign: 'center', 
                                fontSize: '2rem',
                                color: 'var(--accent-gold)',
                                fontFamily: "'Bebas Neue', sans-serif",
                                letterSpacing: '0.1em',
                                marginBottom: '20px'
                            }}>
                                MY WATCHLIST
                            </h2>

                            <div className="watchlist-tabs">
                                <button 
                                    className={`watchlist-tab ${watchlistFilter === null ? 'active' : ''}`}
                                    onClick={() => setWatchlistFilter(null)}
                                >
                                    All Movies ({Object.keys(userProfile.watchlist).length})
                                </button>
                                <button 
                                    className={`watchlist-tab ${watchlistFilter === 'want' ? 'active' : ''}`}
                                    onClick={() => setWatchlistFilter('want')}
                                >
                                    Want to Watch ({getWatchlistMovies('want').length})
                                </button>
                                <button 
                                    className={`watchlist-tab ${watchlistFilter === 'seen' ? 'active' : ''}`}
                                    onClick={() => setWatchlistFilter('seen')}
                                >
                                    Already Seen ({getWatchlistMovies('seen').length})
                                </button>
                            </div>

                            {Object.keys(userProfile.watchlist).length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-icon"></div>
                                    <p>Your watchlist is empty!</p>
                                    <p style={{ fontSize: '0.9rem', opacity: 0.7 }}>
                                        Start browsing movies and add them to your watchlist.
                                    </p>
                                    <button 
                                        className="btn-primary"
                                        onClick={() => setScreen('lobby')}
                                        style={{ marginTop: '20px' }}
                                    >
                                        Browse Movies
                                    </button>
                                </div>
                            ) : (
                                <div className="movie-grid">
                                    {movies.filter(m => {
                                        const ids = getWatchlistMovies(watchlistFilter);
                                        return ids.includes(m.id);
                                    }).map(movie => {
                                        const status = getWatchlistStatus(movie.id);
                                        return (
                                            <div key={movie.id} className="movie-card" style={{ position: 'relative' }}>
                                                <div className={`watchlist-badge ${status}`}>
                                                    {status === 'seen' ? ' Seen' : ' Want'}
                                                </div>
                                                
                                                <img
                                                    src={movie.poster_path ? `${TMDB_IMAGE_BASE}${movie.poster_path}` : ''}
                                                    alt={movie.title}
                                                    className="movie-poster"
                                                    onClick={() => openMovieDetails(movie)}
                                                />
                                                <div className="movie-info">
                                                    <h3 
                                                        className="movie-title"
                                                        onClick={() => openMovieDetails(movie)}
                                                        style={{ cursor: 'pointer' }}
                                                    >
                                                        {movie.title}
                                                    </h3>
                                                    <div className="movie-meta">
                                                        <span>{movie.release_date?.split('-')[0]}</span>
                                                        <span className="rating"> {movie.vote_average?.toFixed(1)}</span>
                                                    </div>
                                                    
                                                    <button 
                                                        className="watchlist-btn remove"
                                                        onClick={() => removeFromWatchlist(movie.id)}
                                                        style={{ width: '100%', marginTop: '10px' }}
                                                    >
                                                        Remove from Watchlist
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </>
                );
            }

            return (
                <>
                    {/* Profile Toggle Button */}
                    <button 
                        className={`profile-toggle-btn ${selectedMovie ? 'hidden' : ''}`}
                        onClick={() => setIsProfileBarMinimized(!isProfileBarMinimized)}
                        title={isProfileBarMinimized ? 'Show Profile Bar' : 'Hide Profile Bar'}
                    >
                        {isProfileBarMinimized ? '' : ''}
                    </button>

                    {/* Profile Bar */}
                    <div className={`profile-bar ${isScrolled ? 'compact' : ''} ${selectedMovie ? 'hidden' : ''} ${isProfileBarMinimized ? 'minimized' : ''}`}>
                        {!userProfile ? (
                            <div className="profile-login">
                                <input
                                    type="text"
                                    placeholder="Enter your name to login"
                                    value={profileLoginInput}
                                    onChange={(e) => setProfileLoginInput(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') loginProfile(profileLoginInput);
                                    }}
                                />
                                <button 
                                    className="profile-btn"
                                    onClick={() => loginProfile(profileLoginInput)}
                                >
                                    Login
                                </button>
                            </div>
                        ) : (
                            <div className="profile-header">
                                {userProfile.photo ? (
                                    <img
                                        src={userProfile.photo}
                                        alt={userProfile.username}
                                        className="profile-avatar"
                                        onClick={() => setScreen('profile')}
                                        title="View Profile"
                                    />
                                ) : (
                                    <div
                                        className="profile-avatar-placeholder"
                                        onClick={() => setScreen('profile')}
                                        title="View Profile"
                                    >
                                        {userProfile.username.charAt(0).toUpperCase()}
                                    </div>
                                )}
                                <span className="profile-name">{userProfile.username}</span>
                                <button 
                                    className="profile-btn"
                                    onClick={() => setScreen('profile')}
                                >
                                     My Watchlist
                                </button>
                                <button 
                                    className="profile-btn"
                                    onClick={logoutProfile}
                                >
                                    Logout
                                </button>
                            </div>
                        )}
                        <div style={{ fontSize: '0.9rem', color: 'var(--accent-gold)' }}>
                             FILMI
                        </div>
                    </div>

                    {/* Movie Details Modal */}
                    {selectedMovie && (
                        <div className="modal-overlay" onClick={closeMovieDetails}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <button className="modal-close" onClick={closeMovieDetails}></button>
                                
                                <div className="modal-header">
                                    {movieDetails?.backdrop_path && (
                                        <img
                                            src={`https://image.tmdb.org/t/p/original${movieDetails.backdrop_path}`}
                                            alt={selectedMovie.title}
                                            className="modal-backdrop"
                                        />
                                    )}
                                    <img
                                        src={selectedMovie.poster_path ? `${TMDB_IMAGE_BASE}${selectedMovie.poster_path}` : ''}
                                        alt={selectedMovie.title}
                                        className="modal-poster"
                                    />
                                </div>

                                <div className="modal-body">
                                    <h2 className="modal-title">{selectedMovie.title}</h2>
                                    
                                    <div className="modal-meta">
                                        <div className="modal-meta-item">
                                             {movieDetails?.release_date?.split('-')[0] || 'N/A'}
                                        </div>
                                        <div className="modal-meta-item">
                                             {selectedMovie.vote_average?.toFixed(1)}/10
                                        </div>
                                        {movieDetails?.runtime && (
                                            <div className="modal-meta-item">
                                                 {Math.floor(movieDetails.runtime / 60)}h {movieDetails.runtime % 60}m
                                            </div>
                                        )}
                                        {movieDetails?.genres && (
                                            <div className="modal-meta-item">
                                                 {movieDetails.genres.map(g => g.name).join(', ')}
                                            </div>
                                        )}
                                    </div>

                                    {selectedMovie.streamingProviders && (
                                        <div className="modal-section">
                                            <div className="modal-section-title">Where to Watch</div>
                                            
                                            {selectedMovie.streamingProviders.flatrate?.length > 0 && (
                                                <div style={{ marginBottom: '15px' }}>
                                                    <div style={{ 
                                                        fontSize: '0.9rem', 
                                                        color: 'var(--accent-gold)', 
                                                        marginBottom: '8px',
                                                        fontWeight: 'bold'
                                                    }}>
                                                         Free with Subscription:
                                                    </div>
                                                    <div className="streaming-info">
                                                        {selectedMovie.streamingProviders.flatrate.map(provider => (
                                                            <a
                                                                key={provider.provider_id}
                                                                href={getStreamingLink(selectedMovie, provider)}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="streaming-link"
                                                                title={`Watch on ${provider.provider_name}`}
                                                            >
                                                                <div className="streaming-badge clickable">
                                                                    {provider.provider_name} 
                                                                </div>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {selectedMovie.streamingProviders.rent?.length > 0 && (
                                                <div style={{ marginBottom: '15px' }}>
                                                    <div style={{ 
                                                        fontSize: '0.9rem', 
                                                        color: '#ff6b6b', 
                                                        marginBottom: '8px',
                                                        fontWeight: 'bold'
                                                    }}>
                                                         Rent or Buy:
                                                    </div>
                                                    <div className="streaming-info">
                                                        {selectedMovie.streamingProviders.rent.map(provider => (
                                                            <a
                                                                key={provider.provider_id}
                                                                href={getStreamingLink(selectedMovie, provider)}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="streaming-link"
                                                                title={`Rent/Buy on ${provider.provider_name}`}
                                                            >
                                                                <div 
                                                                    className="streaming-badge clickable"
                                                                    style={{ background: '#ff6b6b' }}
                                                                >
                                                                    {provider.provider_name} 
                                                                </div>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {selectedMovie.streamingProviders.buy?.length > 0 && 
                                             !selectedMovie.streamingProviders.rent?.some(r => 
                                                selectedMovie.streamingProviders.buy.some(b => b.provider_id === r.provider_id)
                                             ) && (
                                                <div>
                                                    <div style={{ 
                                                        fontSize: '0.9rem', 
                                                        color: '#ffa500', 
                                                        marginBottom: '8px',
                                                        fontWeight: 'bold'
                                                    }}>
                                                         Buy Only:
                                                    </div>
                                                    <div className="streaming-info">
                                                        {selectedMovie.streamingProviders.buy
                                                            .filter(buyProvider => 
                                                                !selectedMovie.streamingProviders.rent?.some(r => r.provider_id === buyProvider.provider_id)
                                                            )
                                                            .map(provider => (
                                                                <a
                                                                    key={provider.provider_id}
                                                                    href={getStreamingLink(selectedMovie, provider)}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="streaming-link"
                                                                    title={`Buy on ${provider.provider_name}`}
                                                                >
                                                                    <div 
                                                                        className="streaming-badge clickable"
                                                                        style={{ background: '#ffa500' }}
                                                                    >
                                                                        {provider.provider_name} 
                                                                    </div>
                                                                </a>
                                                            ))
                                                        }
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {!selectedMovie.streamingProviders.flatrate?.length && 
                                             !selectedMovie.streamingProviders.rent?.length && 
                                             !selectedMovie.streamingProviders.buy?.length && (
                                                <div style={{ color: '#888', fontStyle: 'italic' }}>
                                                    Not currently available for streaming in the US
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="modal-section">
                                        <div className="modal-section-title">Overview</div>
                                        <p className="modal-overview">{selectedMovie.overview || 'No overview available.'}</p>
                                    </div>

                                    {movieDetails?.trailer && (
                                        <div className="modal-section">
                                            <div className="modal-section-title">Trailer</div>
                                            <div className="trailer-container">
                                                <iframe
                                                    src={movieDetails.trailer}
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                    allowFullScreen
                                                    title="Movie Trailer"
                                                />
                                            </div>
                                        </div>
                                    )}

                                    {!movieDetails?.trailer && movieDetails !== null && (
                                        <div className="modal-section">
                                            <div className="modal-section-title">Trailer</div>
                                            <div className="no-trailer">No trailer available</div>
                                        </div>
                                    )}

                                    {movieDetails?.cast && movieDetails.cast.length > 0 && (
                                        <div className="modal-section">
                                            <div className="modal-section-title">Cast</div>
                                            <div className="cast-grid">
                                                {movieDetails.cast.map(actor => (
                                                    <div key={actor.id} className="cast-member">
                                                        {actor.profile_path ? (
                                                            <img
                                                                src={`https://image.tmdb.org/t/p/w185${actor.profile_path}`}
                                                                alt={actor.name}
                                                                className="cast-photo"
                                                            />
                                                        ) : (
                                                            <div className="cast-photo" style={{ background: 'var(--bg-secondary)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem' }}>
                                                                
                                                            </div>
                                                        )}
                                                        <div className="cast-name">{actor.name}</div>
                                                        <div className="cast-character">{actor.character}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="app-container">
                    <div className="header">
                        <div className="marquee-lights">
                            <div className="light"></div>
                            <div className="light"></div>
                            <div className="light"></div>
                            <div className="light"></div>
                            <div className="light"></div>
                        </div>
                        <h1 className="app-title">FILMI</h1>
                        <p className="app-subtitle">Tonight's Feature Presentation</p>
                        <div className={`mode-badge ${mode}`}>
                            {mode === 'local' ? ' Local Session' : ' Online Session'}
                        </div>
                    </div>

                    {error && <div className="error-message">{error}</div>}

                    {mode === 'online' && roomCode && (
                        <div className="room-info">
                            <div className="room-label">Room Code</div>
                            <div className="room-code">{roomCode}</div>
                            <button onClick={copyRoomCode} className="copy-button">
                                 Copy Code
                            </button>
                            
                            {/* Sharing Options */}
                            <div className="sharing-section">
                                <button onClick={() => setShowQRModal(true)} className="share-btn">
                                     Show QR Code
                                </button>
                                <button onClick={copySessionLink} className="share-btn secondary">
                                     Copy Link
                                </button>
                            </div>
                        </div>
                    )}

                    {mode === 'local' && (
                        <div className="user-section">
                            <h2 className="search-header">Movie Night Squad</h2>
                            <div className="user-input-group">
                                <input
                                    type="text"
                                    placeholder="Enter name..."
                                    value={newUserName}
                                    onChange={(e) => setNewUserName(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addLocalUser()}
                                />
                                <button onClick={addLocalUser} className="btn-secondary">Add Person</button>
                            </div>
                            {localUsers.length > 0 && (
                                <div className="user-tags">
                                    {localUsers.map(user => (
                                        <div key={user} className="user-tag">
                                            {user}
                                            <span className="remove-user" onClick={() => removeLocalUser(user)}></span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {mode === 'online' && (
                        <div className="users-list">
                            <div className="users-header">In the Theater ({users.length})</div>
                            <div className="user-tags">
                                {users.map(user => (
                                    <div 
                                        key={user.name} 
                                        className={`user-tag ${user.name === userName ? 'current-user' : ''}`}
                                    >
                                        {user.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="search-section">
                        <h2 className="search-header">Find Your Film</h2>
                        <div className="search-filters">
                            <div className="search-input-container">
                                <input
                                    type="text"
                                    placeholder="Search movies..."
                                    value={searchQuery}
                                    onChange={(e) => handleSearchInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            mode === 'local' ? searchMoviesLocal() : searchMoviesOnline();
                                        } else if (e.key === 'ArrowDown' && searchSuggestions.length > 0) {
                                            e.preventDefault();
                                            setSelectedSuggestionIndex(Math.min(selectedSuggestionIndex + 1, searchSuggestions.length - 1));
                                        } else if (e.key === 'ArrowUp' && searchSuggestions.length > 0) {
                                            e.preventDefault();
                                            setSelectedSuggestionIndex(Math.max(selectedSuggestionIndex - 1, -1));
                                        } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                                            selectSuggestion(searchSuggestions[selectedSuggestionIndex]);
                                        } else if (e.key === 'Escape') {
                                            setShowSuggestions(false);
                                        }
                                    }}
                                    onFocus={() => searchQuery.length >= 2 && setShowSuggestions(true)}
                                    onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                                    autoComplete="off"
                                />
                                {showSuggestions && searchSuggestions.length > 0 && (
                                    <div className="search-suggestions">
                                        {searchSuggestions.map((suggestion, index) => (
                                            <div
                                                key={`${suggestion.type}-${suggestion.id}`}
                                                className={`suggestion-item ${index === selectedSuggestionIndex ? 'selected' : ''}`}
                                                onClick={() => selectSuggestion(suggestion)}
                                            >
                                                {suggestion.poster ? (
                                                    <img
                                                        src={`${TMDB_IMAGE_BASE}${suggestion.poster}`}
                                                        alt={suggestion.title}
                                                        className="suggestion-poster"
                                                    />
                                                ) : (
                                                    <div className="suggestion-poster-placeholder">
                                                        {suggestion.type === 'actor' ? '' : ''}
                                                    </div>
                                                )}
                                                <div className="suggestion-info">
                                                    <div className="suggestion-title">
                                                        {suggestion.type === 'actor' && ' '}
                                                        {suggestion.title}
                                                    </div>
                                                    {suggestion.type === 'actor' ? (
                                                        <div className="suggestion-year" style={{ fontSize: '0.8rem' }}>
                                                            Known for: {suggestion.knownFor || suggestion.year}
                                                        </div>
                                                    ) : (
                                                        suggestion.year && (
                                                            <div className="suggestion-year">{suggestion.year}</div>
                                                        )
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <select value={selectedGenre} onChange={(e) => setSelectedGenre(e.target.value)}>
                                <option value="">All Genres</option>
                                {Object.entries(GENRES).map(([id, name]) => (
                                    <option key={id} value={id}>{name}</option>
                                ))}
                            </select>
                            <select value={selectedDecade} onChange={(e) => setSelectedDecade(e.target.value)}>
                                {DECADES.map(decade => (
                                    <option key={decade.value} value={decade.value}>{decade.label}</option>
                                ))}
                            </select>
                            <select value={selectedLanguage} onChange={(e) => setSelectedLanguage(e.target.value)}>
                                {LANGUAGES.map(lang => (
                                    <option key={lang.value} value={lang.value}>{lang.label}</option>
                                ))}
                            </select>
                            <select value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
                                <option value="popularity">Most Popular</option>
                                <option value="new_releases">New Releases (6mo)</option>
                                <option value="highest_rated">Highest Rated (7+)</option>
                            </select>
                            
                            {/* Advanced Filters Row */}
                            <select value={selectedRuntime} onChange={(e) => setSelectedRuntime(e.target.value)}>
                                <option value="">Any Runtime</option>
                                <option value="short">Under 90 min</option>
                                <option value="medium">90-150 min</option>
                                <option value="long">Over 150 min</option>
                            </select>
                            <select value={selectedRating} onChange={(e) => setSelectedRating(e.target.value)}>
                                <option value="">Any Rating</option>
                                <option value="G">G</option>
                                <option value="PG">PG</option>
                                <option value="PG-13">PG-13</option>
                                <option value="R">R</option>
                            </select>
                            <select value={minImdbRating} onChange={(e) => setMinImdbRating(parseFloat(e.target.value))}>
                                <option value="0">Any IMDb Rating</option>
                                <option value="6">6+ Stars</option>
                                <option value="7">7+ Stars</option>
                                <option value="8">8+ Stars</option>
                                <option value="9">9+ Stars</option>
                            </select>
                            
                            <button onClick={() => {
                                // When searching by text, clear all filters first (search overrides filters)
                                if (searchQuery.trim()) {
                                    // Clear filters
                                    setSelectedGenre('');
                                    setSelectedDecade('');
                                    setSelectedLanguage('');
                                    setSortBy('popularity');
                                    setSelectedRuntime('');
                                    setSelectedRating('');
                                    setMinImdbRating(0);
                                }
                                
                                // Then search
                                if (mode === 'local') {
                                    searchMoviesLocal(null, 1, false);
                                } else {
                                    searchMoviesOnline(null, 1, false);
                                }
                            }}>
                                 Search
                            </button>
                            
                            {/* Clear Filters button - shows when any filter/search is active, always goes home */}
                            {(searchQuery || selectedGenre || selectedDecade || selectedLanguage !== '' || sortBy !== 'popularity' || selectedRuntime || selectedRating || minImdbRating > 0 || hasLocalSearchResults) && (
                                <button 
                                    onClick={resetToHome}
                                    style={{ background: 'var(--accent-red)', borderColor: 'var(--accent-red)' }}
                                    title="Clear all filters and search, return to popular movies"
                                >
                                     Clear Filters
                                </button>
                            )}
                        </div>
                    </div>

                    <div style={{ paddingTop: isScrolled ? '90px' : '140px', transition: 'padding-top 0.3s ease' }}>
                    {/* Phase Banner */}
                    {(() => {
                        const currentPhase = mode === 'local' ? localVotingPhase : sessionData?.votingPhase;
                        const maxFavorites = (mode === 'local' ? largeGroupMode : sessionData?.largeGroupMode) ? 1 : 3;
                        const isHost = mode === 'local' || userName === sessionData?.host;

                        return (
                            <>
                                {currentPhase === VOTING_PHASES.BROWSING && (
                                    <div className="phase-banner">
                                        <h2 className="phase-title">Phase 1: Select Your Favorites</h2>
                                        <p className="phase-description">
                                            Browse movies and mark up to {maxFavorites} as favorites
                                        </p>
                                        
                                        {isHost && (
                                            <div className="host-controls">
                                                <label className="toggle-switch" onClick={toggleLargeGroupMode}>
                                                    <span>Large Group Mode (1 favorite only)</span>
                                                    <input 
                                                        type="checkbox" 
                                                        checked={mode === 'local' ? largeGroupMode : sessionData?.largeGroupMode}
                                                        readOnly
                                                    />
                                                </label>
                                                <button 
                                                    onClick={mode === 'local' ? proceedToFinalVoteLocal : proceedToFinalVoteOnline}
                                                    className="btn-secondary"
                                                >
                                                    Proceed to Final Vote 
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {currentPhase === VOTING_PHASES.FINAL_VOTE && (
                                    <div className="phase-banner">
                                        <h2 className="phase-title">Phase 2: Rank Your Top 3</h2>
                                        <p className="phase-description">
                                            Vote for your 1st, 2nd, and 3rd choice from the favorited movies
                                        </p>
                                        
                                        {isHost && (
                                            <div className="host-controls">
                                                <button 
                                                    onClick={mode === 'local' ? announceWinnerLocal : announceWinnerOnline}
                                                >
                                                     Announce Winner
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        );
                    })()}

                    {loading && <div className="loading">Loading films from the vault...</div>}

                    {!loading && movies.length === 0 && (
                        <div className="empty-state">
                            <div className="empty-state-icon"></div>
                            <p>No films found. Try a different search!</p>
                        </div>
                    )}

                    {/* Phase-based content rendering */}
                    {(() => {
                        const currentPhase = mode === 'local' ? localVotingPhase : sessionData?.votingPhase;
                        const currentUser = mode === 'local' ? localUsers[0] : userName;
                        const maxFavorites = (mode === 'local' ? largeGroupMode : sessionData?.largeGroupMode) ? 1 : 3;
                        const isHost = mode === 'local' || userName === sessionData?.host;

                        // Phase 1: Browsing and Favoriting
                        if (currentPhase === VOTING_PHASES.BROWSING && !loading && movies.length > 0) {
                            const currentUser = mode === 'local' ? localUsers[currentVoterIndex] : userName;
                            
                            return (
                                <>
                                    {/* Phase 1 Progress Tracker */}
                                    {mode === 'local' && localUsers.length > 0 && (
                                        <div className="phase-banner" style={{ marginBottom: '20px' }}>
                                            <h3 className="phase-title" style={{ fontSize: '1.5rem', marginBottom: '10px' }}>
                                                {currentUser}'s Turn
                                            </h3>
                                            <p className="phase-description">
                                                Select up to {largeGroupMode ? '1 favorite' : '3 favorites'}, then submit your votes
                                            </p>
                                            
                                            {/* Submission Counter */}
                                            <div className="phase-stats">
                                                <div className="stat-badge">
                                                    <strong>{getSubmittedCount('favorites')}/{localUsers.length}</strong> submitted
                                                </div>
                                                {getUserFavoriteCount(currentUser) > 0 && (
                                                    <div className="stat-badge">
                                                        You picked: <strong>{getUserFavoriteCount(currentUser)}</strong>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="host-controls">
                                                {!hasUserSubmitted('favorites', currentUser) ? (
                                                    <button 
                                                        onClick={() => {
                                                            submitFavoritesLocal(currentUser);
                                                            if (currentVoterIndex < localUsers.length - 1) {
                                                                setCurrentVoterIndex(currentVoterIndex + 1);
                                                            }
                                                        }}
                                                        style={{ background: 'var(--accent-gold)' }}
                                                        disabled={getUserFavoriteCount(currentUser) === 0}
                                                    >
                                                         Submit My Votes
                                                    </button>
                                                ) : (
                                                    <div style={{ padding: '10px 20px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)' }}>
                                                         Votes Submitted!
                                                    </div>
                                                )}
                                                
                                                {currentVoterIndex > 0 && (
                                                    <button 
                                                        onClick={() => setCurrentVoterIndex(currentVoterIndex - 1)}
                                                        className="btn-secondary"
                                                    >
                                                         Previous Person
                                                    </button>
                                                )}
                                                {currentVoterIndex < localUsers.length - 1 && (
                                                    <button 
                                                        onClick={() => setCurrentVoterIndex(currentVoterIndex + 1)}
                                                        className="btn-secondary"
                                                    >
                                                        Next Person 
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {/* Ready to proceed indicator */}
                                            {getSubmittedCount('favorites') === localUsers.length && (
                                                <div style={{ marginTop: '15px', padding: '15px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)', textAlign: 'center', fontWeight: 'bold' }}>
                                                     Everyone has voted! Ready to proceed to final vote.
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Online mode: Show submission status */}
                                    {mode === 'online' && (
                                        <div className="phase-banner" style={{ marginBottom: '20px' }}>
                                            <div className="phase-stats">
                                                <div className="stat-badge">
                                                    <strong>{getSubmittedCount('favorites')}/{Object.keys(sessionData?.users || {}).length}</strong> submitted
                                                </div>
                                                {getUserFavoriteCount(userName) > 0 && (
                                                    <div className="stat-badge">
                                                        You picked: <strong>{getUserFavoriteCount(userName)}</strong>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Show participants list for host */}
                                            {(mode === 'local' || userName === sessionData?.host) && sessionData?.users && (
                                                <div style={{ 
                                                    marginTop: '15px', 
                                                    padding: '15px', 
                                                    background: 'rgba(218, 165, 32, 0.1)', 
                                                    border: '1px solid var(--accent-gold)',
                                                    borderRadius: '8px' 
                                                }}>
                                                    <h4 style={{ 
                                                        color: 'var(--accent-gold)', 
                                                        marginBottom: '10px',
                                                        fontSize: '1rem',
                                                        fontFamily: "'Bebas Neue', sans-serif"
                                                    }}>
                                                        PARTICIPANTS
                                                    </h4>
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                                        {Object.keys(sessionData.users).map(user => (
                                                            <div key={user} style={{ 
                                                                display: 'flex', 
                                                                justifyContent: 'space-between', 
                                                                alignItems: 'center',
                                                                padding: '8px',
                                                                background: 'rgba(255, 255, 255, 0.05)',
                                                                borderRadius: '4px'
                                                            }}>
                                                                <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                    {user === sessionData.host && ' '}
                                                                    {user}
                                                                    {sessionData?.favoritesSubmitted?.[user] && ' '}
                                                                </span>
                                                                {user !== sessionData.host && user !== userName && (
                                                                    <button
                                                                        onClick={() => removeParticipant(user)}
                                                                        style={{
                                                                            padding: '4px 12px',
                                                                            background: 'var(--accent-red)',
                                                                            border: 'none',
                                                                            borderRadius: '4px',
                                                                            color: 'white',
                                                                            cursor: 'pointer',
                                                                            fontSize: '0.85rem'
                                                                        }}
                                                                    >
                                                                        Remove
                                                                    </button>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <div className="host-controls">
                                                {!hasUserSubmitted('favorites', userName) ? (
                                                    <button 
                                                        onClick={submitFavoritesOnline}
                                                        style={{ background: 'var(--accent-gold)' }}
                                                        disabled={getUserFavoriteCount(userName) === 0}
                                                    >
                                                         Submit My Votes
                                                    </button>
                                                ) : (
                                                    <div style={{ padding: '10px 20px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)' }}>
                                                         Votes Submitted!
                                                    </div>
                                                )}
                                                
                                                {/* Host can force advance even if not everyone submitted */}
                                                {(mode === 'local' || userName === sessionData?.host) && getSubmittedCount('favorites') > 0 && (
                                                    <button 
                                                        onClick={proceedToFinalVoteOnline}
                                                        className="btn-secondary"
                                                        style={{ background: 'var(--accent-gold)', color: '#000', fontWeight: 'bold' }}
                                                    >
                                                        Proceed to Final Vote 
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {getSubmittedCount('favorites') === Object.keys(sessionData?.users || {}).length && (
                                                <div style={{ marginTop: '15px', padding: '15px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)', textAlign: 'center', fontWeight: 'bold' }}>
                                                     Everyone has voted! Ready to proceed to final vote.
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    <div className="movie-grid">
                                    {applyAdvancedFilters(movies).map(movie => {
                                        const favoriteCount = getMovieFavoriteCount(movie.id);
                                        const isFavorited = mode === 'local' 
                                            ? localFavorites[movie.id]?.[currentUser]
                                            : sessionData?.favorites?.[movie.id]?.[userName];
                                        const userFavCount = getUserFavoriteCount(currentUser || userName);
                                        
                                        return (
                                            <div key={movie.id} className="movie-card">
                                                {favoriteCount > 0 && (
                                                    <div className="favorite-count-badge">
                                                         {favoriteCount}
                                                    </div>
                                                )}
                                                <img
                                                    src={movie.poster_path ? `${TMDB_IMAGE_BASE}${movie.poster_path}` : ''}
                                                    alt={movie.title}
                                                    className="movie-poster"
                                                    onClick={() => openMovieDetails(movie)}
                                                    style={{ cursor: 'pointer' }}
                                                />
                                                <div className="movie-info">
                                                    <h3 
                                                        className="movie-title"
                                                        onClick={() => openMovieDetails(movie)}
                                                        style={{ cursor: 'pointer' }}
                                                    >
                                                        {movie.title}
                                                    </h3>
                                                    <div className="movie-meta">
                                                        <span>{movie.release_date?.split('-')[0]}</span>
                                                        <span> {movie.vote_average?.toFixed(1)}</span>
                                                    </div>
                                                    <p className="movie-overview">{movie.overview}</p>
                                                    
                                                    {movie.streamingProviders && (
                                                        <div className="streaming-info">
                                                            {movie.streamingProviders.flatrate?.length > 0 && (
                                                                <>
                                                                    <div style={{ 
                                                                        fontSize: '0.75rem', 
                                                                        color: 'var(--accent-gold)', 
                                                                        marginBottom: '5px', 
                                                                        width: '100%',
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                         Free with subscription:
                                                                    </div>
                                                                    {movie.streamingProviders.flatrate.slice(0, 4).map(provider => (
                                                                        <div key={provider.provider_id} className="streaming-badge" title={provider.provider_name}>
                                                                            {provider.provider_name}
                                                                        </div>
                                                                    ))}
                                                                    {movie.streamingProviders.flatrate.length > 4 && (
                                                                        <div className="streaming-badge" style={{ opacity: 0.7 }}>
                                                                            +{movie.streamingProviders.flatrate.length - 4} more
                                                                        </div>
                                                                    )}
                                                                </>
                                                            )}
                                                            {movie.streamingProviders.rent?.length > 0 && !movie.streamingProviders.flatrate?.length && (
                                                                <>
                                                                    <div style={{ 
                                                                        fontSize: '0.75rem', 
                                                                        color: '#ff6b6b', 
                                                                        marginBottom: '5px', 
                                                                        width: '100%',
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                         Rent or Buy:
                                                                    </div>
                                                                    {movie.streamingProviders.rent.slice(0, 3).map(provider => (
                                                                        <div key={provider.provider_id} className="streaming-badge" style={{ background: '#ff6b6b' }} title={provider.provider_name}>
                                                                            {provider.provider_name}
                                                                        </div>
                                                                    ))}
                                                                    {movie.streamingProviders.rent.length > 3 && (
                                                                        <div className="streaming-badge" style={{ background: '#ff6b6b', opacity: 0.7 }}>
                                                                            +{movie.streamingProviders.rent.length - 3} more
                                                                        </div>
                                                                    )}
                                                                </>
                                                            )}
                                                            {movie.streamingProviders.buy?.length > 0 && 
                                                             !movie.streamingProviders.flatrate?.length && 
                                                             !movie.streamingProviders.rent?.length && (
                                                                <>
                                                                    <div style={{ 
                                                                        fontSize: '0.75rem', 
                                                                        color: '#ffa500', 
                                                                        marginBottom: '5px', 
                                                                        width: '100%',
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                         Buy only:
                                                                    </div>
                                                                    {movie.streamingProviders.buy.slice(0, 3).map(provider => (
                                                                        <div key={provider.provider_id} className="streaming-badge" style={{ background: '#ffa500' }} title={provider.provider_name}>
                                                                            {provider.provider_name}
                                                                        </div>
                                                                    ))}
                                                                    {movie.streamingProviders.buy.length > 3 && (
                                                                        <div className="streaming-badge" style={{ background: '#ffa500', opacity: 0.7 }}>
                                                                            +{movie.streamingProviders.buy.length - 3} more
                                                                        </div>
                                                                    )}
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    <button
                                                        className={`favorite-btn ${isFavorited ? 'active' : ''}`}
                                                        onClick={() => mode === 'local' 
                                                            ? handleFavoriteLocal(movie.id, currentUser)
                                                            : handleFavoriteOnline(movie.id)
                                                        }
                                                        disabled={!isFavorited && userFavCount >= maxFavorites}
                                                    >
                                                        {isFavorited ? ' FAVORITED' : ` ADD TO FAVORITES (${userFavCount}/${maxFavorites})`}
                                                    </button>
                                                    
                                                    {/* Watchlist Buttons - Only show if user is logged in */}
                                                    {userProfile && (
                                                        <div className="watchlist-buttons">
                                                            {getWatchlistStatus(movie.id) === 'seen' ? (
                                                                <button 
                                                                    className="watchlist-btn active"
                                                                    onClick={() => removeFromWatchlist(movie.id)}
                                                                >
                                                                     Seen
                                                                </button>
                                                            ) : (
                                                                <button 
                                                                    className="watchlist-btn"
                                                                    onClick={() => addToWatchlist(movie.id, 'seen')}
                                                                >
                                                                    Mark as Seen
                                                                </button>
                                                            )}
                                                            
                                                            {getWatchlistStatus(movie.id) === 'want' ? (
                                                                <button 
                                                                    className="watchlist-btn active"
                                                                    onClick={() => removeFromWatchlist(movie.id)}
                                                                >
                                                                     Want to Watch
                                                                </button>
                                                            ) : (
                                                                <button 
                                                                    className="watchlist-btn"
                                                                    onClick={() => addToWatchlist(movie.id, 'want')}
                                                                >
                                                                    Want to Watch
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {/* Load More Button */}
                                {(mode === 'local' ? hasMorePages : sessionData?.hasMorePages !== false) && (
                                    <div style={{ display: 'flex', justifyContent: 'center', margin: '30px 0' }}>
                                        <button 
                                            onClick={loadMoreMovies}
                                            disabled={loading}
                                            style={{
                                                padding: '15px 40px',
                                                fontSize: '1.1rem',
                                                background: loading ? 'var(--bg-secondary)' : 'var(--accent-gold)',
                                                color: 'var(--bg-primary)',
                                                border: 'none',
                                                borderRadius: '8px',
                                                cursor: loading ? 'not-allowed' : 'pointer',
                                                fontFamily: "'Bebas Neue', sans-serif",
                                                letterSpacing: '0.1em',
                                                transition: 'all 0.3s ease',
                                                opacity: loading ? 0.6 : 1
                                            }}
                                            onMouseEnter={(e) => !loading && (e.target.style.transform = 'translateY(-2px)')}
                                            onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                                        >
                                            {loading ? ' Loading...' : ' Load More Movies'}
                                        </button>
                                    </div>
                                )}
                                </>
                            );
                        }

                        // Phase 2: Final Ranked Voting
                        if (currentPhase === VOTING_PHASES.FINAL_VOTE && !loading) {
                            const currentUser = mode === 'local' ? localUsers[currentVoterIndex] : userName;
                            const favoritedMovies = getFavoritedMovies();
                            const userVotes = getUserRankedVotes(currentUser || userName);

                            if (favoritedMovies.length === 0) {
                                return (
                                    <div className="empty-state">
                                        <div className="empty-state-icon"></div>
                                        <p>No movies were favorited. Go back to browsing phase.</p>
                                    </div>
                                );
                            }

                            return (
                                <>
                                    {/* Phase 2 Progress Tracker - Local Mode */}
                                    {mode === 'local' && localUsers.length > 0 && (
                                        <div className="phase-banner" style={{ marginBottom: '20px' }}>
                                            <h3 className="phase-title" style={{ fontSize: '1.5rem', marginBottom: '10px' }}>
                                                {currentUser}'s Turn to Rank
                                            </h3>
                                            <p className="phase-description">
                                                Pick your 1st, 2nd, and 3rd choices, then submit
                                            </p>
                                            
                                            {/* Submission Counter */}
                                            <div className="phase-stats">
                                                <div className="stat-badge">
                                                    <strong>{getSubmittedCount('ranked')}/{localUsers.length}</strong> submitted
                                                </div>
                                                {userVotes.first || userVotes.second || userVotes.third ? (
                                                    <div className="stat-badge">
                                                        You ranked: <strong>
                                                            {[userVotes.first, userVotes.second, userVotes.third].filter(Boolean).length}/3
                                                        </strong>
                                                    </div>
                                                ) : null}
                                            </div>

                                            <div className="host-controls">
                                                {!hasUserSubmitted('ranked', currentUser) ? (
                                                    <button 
                                                        onClick={() => {
                                                            submitRankedVotesLocal(currentUser);
                                                            if (currentVoterIndex < localUsers.length - 1) {
                                                                setCurrentVoterIndex(currentVoterIndex + 1);
                                                            }
                                                        }}
                                                        style={{ background: 'var(--accent-gold)' }}
                                                        disabled={!userVotes.first && !userVotes.second && !userVotes.third}
                                                    >
                                                         Submit My Rankings
                                                    </button>
                                                ) : (
                                                    <div style={{ padding: '10px 20px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)' }}>
                                                         Rankings Submitted!
                                                    </div>
                                                )}
                                                
                                                {currentVoterIndex > 0 && (
                                                    <button 
                                                        onClick={() => setCurrentVoterIndex(currentVoterIndex - 1)}
                                                        className="btn-secondary"
                                                    >
                                                         Previous Person
                                                    </button>
                                                )}
                                                {currentVoterIndex < localUsers.length - 1 && (
                                                    <button 
                                                        onClick={() => setCurrentVoterIndex(currentVoterIndex + 1)}
                                                        className="btn-secondary"
                                                    >
                                                        Next Person 
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {/* Sticky Submit Button at Bottom */}
                                            {!hasUserSubmitted('ranked', currentUser) && (
                                                <button 
                                                    className="btn-primary sticky-submit-button"
                                                    onClick={() => {
                                                        submitRankedVotesLocal(currentUser);
                                                        if (currentVoterIndex < localUsers.length - 1) {
                                                            setCurrentVoterIndex(currentVoterIndex + 1);
                                                        }
                                                    }}
                                                    style={{ background: 'var(--accent-gold)', color: '#000' }}
                                                    disabled={!userVotes.first && !userVotes.second && !userVotes.third}
                                                >
                                                     Submit My Rankings
                                                </button>
                                            )}
                                            
                                            {/* Ready to announce winner */}
                                            {getSubmittedCount('ranked') === localUsers.length && (
                                                <div style={{ marginTop: '15px', padding: '15px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)', textAlign: 'center', fontWeight: 'bold' }}>
                                                     Everyone has voted! Ready to announce the winner.
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Phase 2 Progress - Online Mode */}
                                    {mode === 'online' && (
                                        <div className="phase-banner" style={{ marginBottom: '20px' }}>
                                            <div className="phase-stats">
                                                <div className="stat-badge">
                                                    <strong>{getSubmittedCount('ranked')}/{Object.keys(sessionData?.users || {}).length}</strong> submitted
                                                </div>
                                                {userVotes.first || userVotes.second || userVotes.third ? (
                                                    <div className="stat-badge">
                                                        You ranked: <strong>
                                                            {[userVotes.first, userVotes.second, userVotes.third].filter(Boolean).length}/3
                                                        </strong>
                                                    </div>
                                                ) : null}
                                            </div>
                                            
                                            {/* Show participants list for host */}
                                            {(mode === 'local' || userName === sessionData?.host) && sessionData?.users && (
                                                <div style={{ 
                                                    marginTop: '15px', 
                                                    padding: '15px', 
                                                    background: 'rgba(218, 165, 32, 0.1)', 
                                                    border: '1px solid var(--accent-gold)',
                                                    borderRadius: '8px' 
                                                }}>
                                                    <h4 style={{ 
                                                        color: 'var(--accent-gold)', 
                                                        marginBottom: '10px',
                                                        fontSize: '1rem',
                                                        fontFamily: "'Bebas Neue', sans-serif"
                                                    }}>
                                                        VOTING STATUS
                                                    </h4>
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                                        {Object.keys(sessionData.users).map(user => (
                                                            <div key={user} style={{ 
                                                                display: 'flex', 
                                                                justifyContent: 'space-between', 
                                                                alignItems: 'center',
                                                                padding: '8px',
                                                                background: 'rgba(255, 255, 255, 0.05)',
                                                                borderRadius: '4px'
                                                            }}>
                                                                <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                    {user === sessionData.host && ' '}
                                                                    {user}
                                                                    {sessionData?.rankedSubmitted?.[user] && ' '}
                                                                </span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <div className="host-controls">
                                                {!hasUserSubmitted('ranked', userName) ? (
                                                    <button 
                                                        onClick={submitRankedVotesOnline}
                                                        style={{ background: 'var(--accent-gold)' }}
                                                        disabled={!userVotes.first && !userVotes.second && !userVotes.third}
                                                    >
                                                         Submit My Rankings
                                                    </button>
                                                ) : (
                                                    <div style={{ padding: '10px 20px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)' }}>
                                                         Rankings Submitted!
                                                    </div>
                                                )}
                                                
                                                {/* Host can force announce winner even if not everyone submitted */}
                                                {(mode === 'local' || userName === sessionData?.host) && getSubmittedCount('ranked') > 0 && (
                                                    <button 
                                                        onClick={announceWinnerOnline}
                                                        style={{ background: 'var(--accent-gold)', color: '#000', fontWeight: 'bold' }}
                                                    >
                                                         Announce Winner
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {/* Sticky Submit Button at Bottom */}
                                            {!hasUserSubmitted('ranked', userName) && (
                                                <button 
                                                    className="btn-primary sticky-submit-button"
                                                    onClick={submitRankedVotesOnline}
                                                    style={{ background: 'var(--accent-gold)', color: '#000' }}
                                                    disabled={!userVotes.first && !userVotes.second && !userVotes.third}
                                                >
                                                     Submit My Rankings
                                                </button>
                                            )}
                                            
                                            {getSubmittedCount('ranked') === Object.keys(sessionData?.users || {}).length && (
                                                <div style={{ marginTop: '15px', padding: '15px', background: 'var(--accent-gold)', borderRadius: '8px', color: 'var(--bg-primary)', textAlign: 'center', fontWeight: 'bold' }}>
                                                     Everyone has voted! Ready to announce the winner.
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    <div className="movie-grid">
                                    {favoritedMovies.map(movie => {
                                        return (
                                            <div key={movie.id} className="movie-card">
                                                <img
                                                    src={movie.poster_path ? `${TMDB_IMAGE_BASE}${movie.poster_path}` : ''}
                                                    alt={movie.title}
                                                    className="movie-poster"
                                                    onClick={() => openMovieDetails(movie)}
                                                    style={{ cursor: 'pointer' }}
                                                />
                                                <div className="movie-info">
                                                    <h3 
                                                        className="movie-title"
                                                        onClick={() => openMovieDetails(movie)}
                                                        style={{ cursor: 'pointer' }}
                                                    >
                                                        {movie.title}
                                                    </h3>
                                                    <div className="movie-meta">
                                                        <span>{movie.release_date?.split('-')[0]}</span>
                                                        <span> {movie.vote_average?.toFixed(1)}</span>
                                                    </div>
                                                    <p className="movie-overview">{movie.overview}</p>
                                                    
                                                    {movie.streamingProviders && (
                                                        <div className="streaming-info">
                                                            {movie.streamingProviders.flatrate?.length > 0 && (
                                                                <>
                                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '5px', width: '100%' }}>
                                                                        Stream on:
                                                                    </div>
                                                                    {movie.streamingProviders.flatrate.slice(0, 4).map(provider => (
                                                                        <div key={provider.provider_id} className="streaming-badge" title={provider.provider_name}>
                                                                            {provider.provider_name}
                                                                        </div>
                                                                    ))}
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    <div className="ranked-voting-buttons">
                                                        <button
                                                            className={`rank-btn first ${userVotes.first === movie.id ? 'active' : ''}`}
                                                            onClick={() => mode === 'local'
                                                                ? handleRankedVoteLocal(currentUser, 'first', movie.id)
                                                                : handleRankedVoteOnline('first', movie.id)
                                                            }
                                                        >
                                                            <span className="rank-icon"></span>
                                                            <span>1st Choice</span>
                                                            <span className="rank-points">3 points</span>
                                                        </button>
                                                        
                                                        <button
                                                            className={`rank-btn second ${userVotes.second === movie.id ? 'active' : ''}`}
                                                            onClick={() => mode === 'local'
                                                                ? handleRankedVoteLocal(currentUser, 'second', movie.id)
                                                                : handleRankedVoteOnline('second', movie.id)
                                                            }
                                                        >
                                                            <span className="rank-icon"></span>
                                                            <span>2nd Choice</span>
                                                            <span className="rank-points">2 points</span>
                                                        </button>
                                                        
                                                        <button
                                                            className={`rank-btn third ${userVotes.third === movie.id ? 'active' : ''}`}
                                                            onClick={() => mode === 'local'
                                                                ? handleRankedVoteLocal(currentUser, 'third', movie.id)
                                                                : handleRankedVoteOnline('third', movie.id)
                                                            }
                                                        >
                                                            <span className="rank-icon"></span>
                                                            <span>3rd Choice</span>
                                                            <span className="rank-points">1 point</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                </>
                            );
                        }

                        // Phase 3: Winner Announced
                        if (currentPhase === VOTING_PHASES.WINNER) {
                            const winner = getWinner();
                            const rankedResults = getRankedResults();

                            if (!winner) {
                                return (
                                    <div className="empty-state">
                                        <div className="empty-state-icon"></div>
                                        <p>No votes were cast. Cannot determine winner.</p>
                                    </div>
                                );
                            }

                            return (
                                <div className="results-section">
                                    <h2 className="results-header"> Tonight's Winner</h2>
                                    
                                    <div 
                                        className="winner-card"
                                        onClick={() => openMovieDetails(winner)}
                                        style={{ cursor: 'pointer' }}
                                        title="Click to see full details"
                                    >
                                        <img
                                            src={winner.poster_path ? `${TMDB_IMAGE_BASE}${winner.poster_path}` : ''}
                                            alt={winner.title}
                                            className="winner-poster"
                                        />
                                        <h3 className="winner-title">{winner.title}</h3>
                                        <p className="winner-score">Score: {winner.score} points</p>
                                        
                                        <button 
                                            className="btn-primary"
                                            style={{ 
                                                margin: '15px auto',
                                                background: 'var(--accent-gold)',
                                                color: '#000'
                                            }}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                openMovieDetails(winner);
                                            }}
                                        >
                                             View Full Details
                                        </button>
                                        
                                        {winner.streamingProviders && (
                                            <div style={{ marginBottom: '20px' }}>
                                                {winner.streamingProviders.flatrate?.length > 0 && (
                                                    <div>
                                                        <div style={{ 
                                                            fontSize: '1rem', 
                                                            color: 'var(--accent-gold)', 
                                                            marginBottom: '10px',
                                                            fontFamily: "'Bebas Neue', sans-serif",
                                                            letterSpacing: '0.1em'
                                                        }}>
                                                            STREAM ON:
                                                        </div>
                                                        <div className="streaming-info" style={{ justifyContent: 'center' }}>
                                                            {winner.streamingProviders.flatrate.map(provider => (
                                                                <a
                                                                    key={provider.provider_id}
                                                                    href={getStreamingLink(winner, provider)}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="streaming-link"
                                                                    title={`Watch on ${provider.provider_name}`}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    <div 
                                                                        className="streaming-badge clickable"
                                                                        style={{ fontSize: '0.9rem', padding: '6px 14px' }}
                                                                    >
                                                                        {provider.provider_name} 
                                                                    </div>
                                                                </a>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                {winner.streamingProviders.rent?.length > 0 && !winner.streamingProviders.flatrate?.length && (
                                                    <div>
                                                        <div style={{ 
                                                            fontSize: '1rem', 
                                                            color: 'var(--accent-gold)', 
                                                            marginBottom: '10px',
                                                            fontFamily: "'Bebas Neue', sans-serif",
                                                            letterSpacing: '0.1em'
                                                        }}>
                                                            RENT OR BUY ON:
                                                        </div>
                                                        <div className="streaming-info" style={{ justifyContent: 'center' }}>
                                                            {winner.streamingProviders.rent.map(provider => (
                                                                <a
                                                                    key={provider.provider_id}
                                                                    href={getStreamingLink(winner, provider)}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="streaming-link"
                                                                    title={`Rent/Buy on ${provider.provider_name}`}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    <div 
                                                                        className="streaming-badge clickable"
                                                                        style={{ 
                                                                            background: 'var(--accent-gold)',
                                                                            fontSize: '0.9rem',
                                                                            padding: '6px 14px'
                                                                        }}
                                                                    >
                                                                        {provider.provider_name} 
                                                                    </div>
                                                                </a>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        <p>{winner.overview}</p>
                                        
                                        {/* Voting Breakdown */}
                                        {(() => {
                                            const breakdown = getVotingBreakdown(winner.id);
                                            const hasVotes = breakdown.first.length > 0 || breakdown.second.length > 0 || breakdown.third.length > 0;
                                            
                                            if (hasVotes) {
                                                return (
                                                    <div style={{ 
                                                        marginTop: '30px', 
                                                        padding: '20px', 
                                                        background: 'rgba(218, 165, 32, 0.1)',
                                                        border: '1px solid var(--accent-gold)',
                                                        borderRadius: '8px'
                                                    }}>
                                                        <h4 style={{ 
                                                            color: 'var(--accent-gold)', 
                                                            marginBottom: '15px',
                                                            fontFamily: "'Bebas Neue', sans-serif",
                                                            fontSize: '1.3rem',
                                                            letterSpacing: '0.1em'
                                                        }}>
                                                             VOTING BREAKDOWN
                                                        </h4>
                                                        {breakdown.first.length > 0 && (
                                                            <div style={{ marginBottom: '10px' }}>
                                                                <span style={{ color: '#FFD700', fontWeight: 'bold' }}> 1st Choice ({RANKED_VOTE_POINTS.first} pts): </span>
                                                                <span style={{ color: '#e0e0e0' }}>{breakdown.first.join(', ')}</span>
                                                            </div>
                                                        )}
                                                        {breakdown.second.length > 0 && (
                                                            <div style={{ marginBottom: '10px' }}>
                                                                <span style={{ color: '#C0C0C0', fontWeight: 'bold' }}> 2nd Choice ({RANKED_VOTE_POINTS.second} pts): </span>
                                                                <span style={{ color: '#e0e0e0' }}>{breakdown.second.join(', ')}</span>
                                                            </div>
                                                        )}
                                                        {breakdown.third.length > 0 && (
                                                            <div>
                                                                <span style={{ color: '#CD7F32', fontWeight: 'bold' }}> 3rd Choice ({RANKED_VOTE_POINTS.third} pt): </span>
                                                                <span style={{ color: '#e0e0e0' }}>{breakdown.third.join(', ')}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </div>

                                    {rankedResults.length > 1 && (
                                        <div className="ranked-list">
                                            <h3 className="search-header">Final Results</h3>
                                            {rankedResults.map((movie, index) => {
                                                const breakdown = getVotingBreakdown(movie.id);
                                                return (
                                                    <div key={movie.id} className="ranked-item">
                                                        <div className="rank-number">#{index + 1}</div>
                                                        <img
                                                            src={movie.poster_path ? `${TMDB_IMAGE_BASE}${movie.poster_path}` : ''}
                                                            alt={movie.title}
                                                            className="ranked-poster"
                                                        />
                                                        <div className="ranked-info">
                                                            <div className="ranked-title">{movie.title}</div>
                                                            <div className="ranked-score">{movie.score} points</div>
                                                            {/* Show voting breakdown */}
                                                            <div style={{ fontSize: '0.85rem', marginTop: '5px', color: '#b0b0b0' }}>
                                                                {breakdown.first.length > 0 && <div> {breakdown.first.join(', ')}</div>}
                                                                {breakdown.second.length > 0 && <div> {breakdown.second.join(', ')}</div>}
                                                                {breakdown.third.length > 0 && <div> {breakdown.third.join(', ')}</div>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                    
                                    {/* Share Results Button */}
                                    <div className="sharing-section" style={{ marginTop: '30px' }}>
                                        <button onClick={shareResults} className="share-btn">
                                             Share Results
                                        </button>
                                    </div>
                                </div>
                            );
                        }

                        return null;
                    })()}

                    <div className="session-controls">
                        <button onClick={leaveSession} className="btn-secondary">
                            {mode === 'local' ? 'End Session' : 'Leave Session'}
                        </button>
                    </div>
                    </div>
                </div>
                
                {/* QR Code Modal */}
                {showQRModal && mode === 'online' && roomCode && (
                    <div className="qr-modal-overlay" onClick={() => setShowQRModal(false)}>
                        <div className="qr-modal" onClick={(e) => e.stopPropagation()}>
                            <button 
                                className="qr-close-btn"
                                onClick={() => setShowQRModal(false)}
                                title="Close"
                            >
                                
                            </button>
                            
                            <h2 className="qr-modal-title">Scan to Join</h2>
                            
                            <div className="qr-code-container">
                                <img 
                                    src={generateQRCode()} 
                                    alt="QR Code to join session"
                                />
                            </div>
                            
                            <p className="qr-instructions">
                                Scan this QR code with your phone camera to join the session instantly!
                            </p>
                            
                            <div style={{ marginTop: '20px' }}>
                                <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', marginBottom: '10px' }}>
                                    Or share the room code:
                                </p>
                                <div style={{ 
                                    fontSize: '2rem', 
                                    fontWeight: 'bold', 
                                    color: 'var(--accent-gold)',
                                    letterSpacing: '0.2em'
                                }}>
                                    {roomCode}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBzZWxmLnNraXBXYWl0aW5nKCk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgcmV0dXJuIHNlbGYuY2xpZW50cy5jbGFpbSgpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBmdW5jdGlvbihldmVudCkgewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
                    .catch(() => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>
